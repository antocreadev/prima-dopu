---
/**
 * Composant de tutoriel d'onboarding pour les nouveaux utilisateurs
 * Guide pas √† pas interactif pour la premi√®re g√©n√©ration
 * Syst√®me inspir√© des tutoriels de jeux vid√©o / logiciels professionnels
 */
interface Props {
  isFirstTime: boolean;
}

const { isFirstTime } = Astro.props;
---

<div 
  id="onboarding-tutorial" 
  class="fixed inset-0 z-[9999] pointer-events-none"
  data-first-time={isFirstTime ? "true" : "false"}
  style="display: none;"
>
  <!-- Overlay avec "trou" pour spotlight -->
  <svg id="tutorial-overlay-svg" class="absolute inset-0 w-full h-full pointer-events-auto" style="display: none;">
    <defs>
      <mask id="spotlight-mask">
        <rect x="0" y="0" width="100%" height="100%" fill="white"/>
        <rect id="spotlight-hole" x="0" y="0" width="0" height="0" rx="12" fill="black"/>
      </mask>
    </defs>
    <rect 
      x="0" y="0" 
      width="100%" height="100%" 
      fill="rgba(0,0,0,0.75)" 
      mask="url(#spotlight-mask)"
    />
  </svg>

  <!-- Modal de bienvenue (√©tape 0) -->
  <div 
    id="tutorial-welcome" 
    class="absolute inset-0 flex items-center justify-center p-4 pointer-events-auto"
    style="display: none;"
  >
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8 text-center animate-tutorial-appear">
      <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg">
        <span class="text-4xl">üëã</span>
      </div>
      
      <h2 class="text-2xl font-bold text-slate-900 mb-3">
        Bienvenue sur PrimaDopu !
      </h2>
      
      <p class="text-slate-600 mb-6 leading-relaxed">
        Cr√©ez des visuels <strong class="text-indigo-600">avant/apr√®s</strong> professionnels en quelques clics gr√¢ce √† l'IA.
      </p>
      
      <div class="space-y-3 text-left bg-slate-50 rounded-xl p-4 mb-6">
        <div class="flex items-start gap-3">
          <span class="flex items-center justify-center w-7 h-7 rounded-full bg-indigo-100 text-indigo-600 text-sm font-bold shrink-0">1</span>
          <p class="text-sm text-slate-700">T√©l√©chargez une photo de votre espace</p>
        </div>
        <div class="flex items-start gap-3">
          <span class="flex items-center justify-center w-7 h-7 rounded-full bg-indigo-100 text-indigo-600 text-sm font-bold shrink-0">2</span>
          <p class="text-sm text-slate-700">Ajoutez vos instructions de transformation</p>
        </div>
        <div class="flex items-start gap-3">
          <span class="flex items-center justify-center w-7 h-7 rounded-full bg-indigo-100 text-indigo-600 text-sm font-bold shrink-0">3</span>
          <p class="text-sm text-slate-700">L'IA g√©n√®re le r√©sultat en moins de 2 minutes</p>
        </div>
      </div>
      
      <button 
        type="button"
        id="tutorial-start-btn"
        class="w-full py-3 px-6 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-semibold hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg hover:shadow-xl transform hover:scale-[1.02] active:scale-[0.98]"
      >
        Commencer le tutoriel üöÄ
      </button>
      
      <button 
        type="button"
        id="tutorial-skip-btn"
        class="mt-4 text-sm text-slate-500 hover:text-slate-700 transition-colors"
      >
        Passer et explorer par moi-m√™me
      </button>
    </div>
  </div>

  <!-- Tooltip flottant (√©tapes 1-4) -->
  <div 
    id="tutorial-tooltip" 
    class="absolute bg-white rounded-xl shadow-2xl w-80 p-5 pointer-events-auto animate-tutorial-appear"
    style="display: none;"
  >
    <!-- Fl√®che du tooltip -->
    <div id="tooltip-arrow" class="absolute w-4 h-4 bg-white transform rotate-45"></div>
    
    <!-- Contenu -->
    <div class="relative">
      <!-- Header avec num√©ro d'√©tape -->
      <div class="flex items-center gap-3 mb-3">
        <span id="tooltip-step-number" class="flex items-center justify-center w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full font-bold text-sm"></span>
        <h3 id="tooltip-title" class="font-semibold text-slate-900"></h3>
      </div>
      
      <!-- Description -->
      <div id="tooltip-description" class="text-slate-600 text-sm mb-4"></div>
      
      <!-- Footer avec navigation -->
      <div class="flex items-center justify-between pt-3 border-t border-slate-100">
        <span id="tooltip-progress" class="text-xs text-slate-400"></span>
        <div class="flex gap-2">
          <button 
            type="button" 
            id="tooltip-prev-btn"
            class="px-3 py-1.5 text-sm text-slate-600 hover:bg-slate-100 rounded-lg transition-colors flex items-center gap-1"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Retour
          </button>
          <button 
            type="button" 
            id="tooltip-next-btn"
            class="px-4 py-1.5 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-1"
          >
            Suivant
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de fin -->
  <div 
    id="tutorial-complete" 
    class="absolute inset-0 flex items-center justify-center p-4 pointer-events-auto"
    style="display: none;"
  >
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 text-center animate-tutorial-appear">
      <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-green-400 to-emerald-600 rounded-full flex items-center justify-center shadow-lg">
        <span class="text-4xl">üéâ</span>
      </div>
      
      <h2 class="text-2xl font-bold text-slate-900 mb-3">
        Vous √™tes pr√™t !
      </h2>
      
      <p class="text-slate-600 mb-6 leading-relaxed">
        Vous ma√Ætrisez maintenant les bases de PrimaDopu. 
        <strong class="text-indigo-600">Lancez votre premi√®re g√©n√©ration !</strong>
      </p>
      
      <button 
        type="button"
        id="tutorial-finish-btn"
        class="w-full py-3 px-6 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl font-semibold hover:from-green-600 hover:to-emerald-700 transition-all shadow-lg hover:shadow-xl transform hover:scale-[1.02] active:scale-[0.98]"
      >
        C'est parti ! ‚ú®
      </button>
      
      <p class="mt-4 text-xs text-slate-400">
        üí° Vous pouvez revoir ce tutoriel depuis votre profil
      </p>
    </div>
  </div>
</div>

<style>
  @keyframes tutorial-appear {
    from {
      opacity: 0;
      transform: scale(0.95) translateY(10px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  .animate-tutorial-appear {
    animation: tutorial-appear 0.3s ease-out forwards;
  }

  #tutorial-tooltip {
    transition: top 0.3s ease-out, left 0.3s ease-out;
  }

  #spotlight-hole {
    transition: all 0.3s ease-out;
  }
</style>

<script>
  interface TutorialStep {
    id: number;
    targetSelector: string | null;  // null = pas de spotlight, juste modal
    title: string;
    description: string;
    arrowPosition: 'top' | 'bottom' | 'left' | 'right';
    highlightPadding?: number;
    isModal?: boolean;  // Afficher comme modal centr√© sans spotlight
  }

  const TUTORIAL_STEPS: TutorialStep[] = [
    {
      id: 1,
      targetSelector: '#uploadZone',
      title: 'T√©l√©chargez votre photo',
      description: `
        <p class="mb-2">Cliquez ici ou glissez-d√©posez une photo de l'espace √† transformer.</p>
        <div class="bg-amber-50 border border-amber-200 rounded-lg p-2 mt-2">
          <p class="text-xs text-amber-800">üí° <strong>Conseil :</strong> Privil√©giez les photos horizontales pour un meilleur rendu.</p>
        </div>
      `,
      arrowPosition: 'top',
      highlightPadding: 8
    },
    {
      id: 2,
      targetSelector: '#toStep2Btn',
      title: 'Passez aux instructions',
      description: `
        <p>Une fois votre photo charg√©e, ce bouton <strong class="text-indigo-600">"Continuer ‚Üí"</strong> devient actif.</p>
        <p class="text-xs text-slate-500 mt-2">Cliquez dessus pour passer √† l'√©tape suivante.</p>
      `,
      arrowPosition: 'top',
      highlightPadding: 8
    },
    {
      id: 3,
      targetSelector: null,
      isModal: true,
      title: 'Ajoutez vos instructions',
      description: `
        <div class="text-left">
          <p class="mb-3">Dans l'√©cran suivant, vous pourrez :</p>
          <div class="space-y-2">
            <div class="flex items-start gap-2">
              <span class="flex items-center justify-center w-5 h-5 rounded-full bg-indigo-100 text-indigo-600 text-xs font-bold shrink-0 mt-0.5">1</span>
              <p class="text-sm">Cliquer sur <strong>"+ Ajouter une instruction"</strong></p>
            </div>
            <div class="flex items-start gap-2">
              <span class="flex items-center justify-center w-5 h-5 rounded-full bg-indigo-100 text-indigo-600 text-xs font-bold shrink-0 mt-0.5">2</span>
              <p class="text-sm">Indiquer la <strong>zone</strong> (sol, murs, plafond...)</p>
            </div>
            <div class="flex items-start gap-2">
              <span class="flex items-center justify-center w-5 h-5 rounded-full bg-indigo-100 text-indigo-600 text-xs font-bold shrink-0 mt-0.5">3</span>
              <p class="text-sm">Choisir un <strong>mat√©riau de r√©f√©rence</strong></p>
            </div>
          </div>
          <div class="bg-purple-50 border border-purple-200 rounded-lg p-2 mt-3">
            <p class="text-xs text-purple-800">üí° <strong>Astuce :</strong> Ajoutez des photos de mat√©riaux dans votre <a href="/library" class="underline font-medium">biblioth√®que</a> pour des r√©sultats pr√©cis !</p>
          </div>
        </div>
      `,
      arrowPosition: 'top'
    },
    {
      id: 4,
      targetSelector: null,
      isModal: true,
      title: 'Lancez la g√©n√©ration !',
      description: `
        <div class="text-left">
          <p class="mb-3">Quand vos instructions sont pr√™tes :</p>
          <div class="flex items-center gap-3 p-3 bg-indigo-50 rounded-lg mb-3">
            <span class="text-2xl">üöÄ</span>
            <p class="text-sm">Cliquez sur <strong class="text-indigo-600">"G√©n√©rer ‚Üí"</strong> pour lancer l'IA</p>
          </div>
          <div class="flex items-center gap-2 text-sm text-slate-600">
            <span>‚è±Ô∏è</span>
            <p>Le r√©sultat arrive en <strong>moins de 2 minutes</strong></p>
          </div>
        </div>
      `,
      arrowPosition: 'top'
    }
  ];

  class OnboardingTutorial {
    private container: HTMLElement;
    private overlaySvg: SVGElement;
    private spotlightHole: SVGRectElement;
    private welcomeModal: HTMLElement;
    private tooltip: HTMLElement;
    private tooltipArrow: HTMLElement;
    private completeModal: HTMLElement;
    
    private currentStep: number = 0;
    private isActive: boolean = false;
    private resizeObserver: ResizeObserver | null = null;

    constructor() {
      // R√©cup√©rer les √©l√©ments
      this.container = document.getElementById('onboarding-tutorial') as HTMLElement;
      this.overlaySvg = document.getElementById('tutorial-overlay-svg') as unknown as SVGElement;
      this.spotlightHole = document.getElementById('spotlight-hole') as unknown as SVGRectElement;
      this.welcomeModal = document.getElementById('tutorial-welcome') as HTMLElement;
      this.tooltip = document.getElementById('tutorial-tooltip') as HTMLElement;
      this.tooltipArrow = document.getElementById('tooltip-arrow') as HTMLElement;
      this.completeModal = document.getElementById('tutorial-complete') as HTMLElement;

      if (!this.container) {
        console.error('Tutorial container not found');
        return;
      }

      this.init();
    }

    private init() {
      // V√©rifier si on doit afficher le tutoriel
      const isFirstTime = this.container.dataset.firstTime === 'true';
      const tutorialCompleted = localStorage.getItem('primadopu_tutorial_completed');
      const shouldShow = localStorage.getItem('primadopu_show_tutorial');
      
      // Afficher si: premi√®re fois OU demand√© explicitement (replay depuis profil)
      if ((isFirstTime && tutorialCompleted !== 'true') || shouldShow === 'true') {
        // Nettoyer le flag de replay
        localStorage.removeItem('primadopu_show_tutorial');
        this.start();
      }

      this.bindEvents();
    }

    private bindEvents() {
      // Bouton d√©marrer
      document.getElementById('tutorial-start-btn')?.addEventListener('click', () => {
        this.showStep(1);
      });

      // Bouton passer
      document.getElementById('tutorial-skip-btn')?.addEventListener('click', () => {
        this.complete();
      });

      // Navigation tooltip
      document.getElementById('tooltip-prev-btn')?.addEventListener('click', () => {
        this.prevStep();
      });

      document.getElementById('tooltip-next-btn')?.addEventListener('click', () => {
        this.nextStep();
      });

      // Bouton terminer
      document.getElementById('tutorial-finish-btn')?.addEventListener('click', () => {
        this.complete();
      });

      // Fermer avec Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && this.isActive) {
          this.complete();
        }
      });

      // Observer les changements de taille pour repositionner
      this.resizeObserver = new ResizeObserver(() => {
        if (this.isActive && this.currentStep > 0 && this.currentStep <= TUTORIAL_STEPS.length) {
          this.positionTooltipForStep(TUTORIAL_STEPS[this.currentStep - 1]);
        }
      });
      this.resizeObserver.observe(document.body);
    }

    private start() {
      this.container.style.display = 'block';
      this.isActive = true;
      document.body.style.overflow = 'hidden';
      
      // Afficher l'√©cran de bienvenue
      this.showWelcome();
    }

    private showWelcome() {
      this.currentStep = 0;
      this.hideAllPanels();
      this.welcomeModal.style.display = 'flex';
    }

    private showStep(stepNumber: number) {
      const step = TUTORIAL_STEPS.find(s => s.id === stepNumber);
      if (!step) {
        this.showComplete();
        return;
      }

      this.currentStep = stepNumber;
      this.hideAllPanels();

      // Si c'est une √©tape modale (sans spotlight)
      if (step.isModal || !step.targetSelector) {
        this.showModalStep(step);
        return;
      }

      // V√©rifier si l'√©l√©ment cible existe et est visible
      const target = document.querySelector(step.targetSelector) as HTMLElement;
      if (!target || target.offsetParent === null) {
        console.warn(`Target element not found or hidden: ${step.targetSelector}`);
        // Si l'√©l√©ment n'existe pas ou est cach√©, afficher comme modal
        this.showModalStep(step);
        return;
      }

      // Afficher l'overlay et le tooltip
      this.overlaySvg.style.display = 'block';
      this.tooltip.style.display = 'block';

      // Mettre √† jour le contenu du tooltip
      this.updateTooltipContent(step);

      // Positionner le spotlight et le tooltip
      this.positionTooltipForStep(step);
    }

    private showModalStep(step: TutorialStep) {
      // Afficher overlay sombre sans trou
      this.overlaySvg.style.display = 'block';
      // R√©duire le spotlight √† z√©ro pour avoir un overlay complet
      this.spotlightHole.setAttribute('width', '0');
      this.spotlightHole.setAttribute('height', '0');

      // Afficher et centrer le tooltip comme modal
      this.tooltip.style.display = 'block';
      this.tooltipArrow.style.display = 'none'; // Cacher la fl√®che

      // Mettre √† jour le contenu
      this.updateTooltipContent(step);

      // Centrer le tooltip
      const tooltipRect = this.tooltip.getBoundingClientRect();
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;

      this.tooltip.style.top = `${(viewportHeight - tooltipRect.height) / 2}px`;
      this.tooltip.style.left = `${(viewportWidth - tooltipRect.width) / 2}px`;
    }

    private updateTooltipContent(step: TutorialStep) {
      const stepNumber = document.getElementById('tooltip-step-number');
      const title = document.getElementById('tooltip-title');
      const description = document.getElementById('tooltip-description');
      const progress = document.getElementById('tooltip-progress');
      const nextBtn = document.getElementById('tooltip-next-btn');
      const prevBtn = document.getElementById('tooltip-prev-btn');

      if (stepNumber) stepNumber.textContent = step.id.toString();
      if (title) title.textContent = step.title;
      if (description) description.innerHTML = step.description;
      if (progress) progress.textContent = `√âtape ${step.id}/${TUTORIAL_STEPS.length}`;

      // Masquer le bouton retour sur la premi√®re √©tape
      if (prevBtn) prevBtn.style.display = step.id === 1 ? 'none' : 'flex';

      // Changer le texte du bouton suivant sur la derni√®re √©tape
      if (nextBtn) {
        if (step.id === TUTORIAL_STEPS.length) {
          nextBtn.innerHTML = `Terminer <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>`;
          nextBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
          nextBtn.classList.add('bg-green-600', 'hover:bg-green-700');
        } else {
          nextBtn.innerHTML = `Suivant <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>`;
          nextBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
          nextBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
        }
      }
    }

    private positionTooltipForStep(step: TutorialStep) {
      if (!step.targetSelector) return;
      
      const target = document.querySelector(step.targetSelector) as HTMLElement;
      if (!target) return;

      // R√©afficher la fl√®che (au cas o√π elle √©tait cach√©e pour une √©tape modale)
      this.tooltipArrow.style.display = 'block';

      // Faire d√©filer l'√©l√©ment dans la vue si n√©cessaire
      target.scrollIntoView({ behavior: 'smooth', block: 'center' });

      // Attendre un peu que le scroll soit termin√©
      setTimeout(() => {
        const rect = target.getBoundingClientRect();
        const padding = step.highlightPadding || 8;

        // Positionner le spotlight (trou dans l'overlay)
        this.spotlightHole.setAttribute('x', (rect.left - padding).toString());
        this.spotlightHole.setAttribute('y', (rect.top - padding).toString());
        this.spotlightHole.setAttribute('width', (rect.width + padding * 2).toString());
        this.spotlightHole.setAttribute('height', (rect.height + padding * 2).toString());

        // Positionner le tooltip
        const tooltipRect = this.tooltip.getBoundingClientRect();
        const gap = 16;
        let top = 0;
        let left = 0;

        // R√©initialiser les classes de position de la fl√®che
        this.tooltipArrow.className = 'absolute w-4 h-4 bg-white transform rotate-45';

        switch (step.arrowPosition) {
          case 'top':
            // Tooltip en dessous de l'√©l√©ment, fl√®che en haut
            top = rect.bottom + gap;
            left = rect.left + rect.width / 2 - tooltipRect.width / 2;
            this.tooltipArrow.style.cssText = 'display: block; top: -8px; left: 50%; margin-left: -8px;';
            break;
          case 'bottom':
            // Tooltip au-dessus de l'√©l√©ment, fl√®che en bas
            top = rect.top - tooltipRect.height - gap;
            left = rect.left + rect.width / 2 - tooltipRect.width / 2;
            this.tooltipArrow.style.cssText = 'display: block; bottom: -8px; left: 50%; margin-left: -8px;';
            break;
          case 'left':
            // Tooltip √† droite de l'√©l√©ment, fl√®che √† gauche
            top = rect.top + rect.height / 2 - tooltipRect.height / 2;
            left = rect.right + gap;
            this.tooltipArrow.style.cssText = 'display: block; left: -8px; top: 50%; margin-top: -8px;';
            break;
          case 'right':
            // Tooltip √† gauche de l'√©l√©ment, fl√®che √† droite
            top = rect.top + rect.height / 2 - tooltipRect.height / 2;
            left = rect.left - tooltipRect.width - gap;
            this.tooltipArrow.style.cssText = 'display: block; right: -8px; top: 50%; margin-top: -8px;';
            break;
        }

        // S'assurer que le tooltip reste dans la fen√™tre
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;

        if (left < 16) left = 16;
        if (left + tooltipRect.width > viewportWidth - 16) left = viewportWidth - tooltipRect.width - 16;
        if (top < 16) top = 16;
        if (top + tooltipRect.height > viewportHeight - 16) top = viewportHeight - tooltipRect.height - 16;

        this.tooltip.style.top = `${top}px`;
        this.tooltip.style.left = `${left}px`;
      }, 100);
    }

    private showComplete() {
      this.hideAllPanels();
      this.completeModal.style.display = 'flex';
      this.currentStep = TUTORIAL_STEPS.length + 1;
    }

    private hideAllPanels() {
      this.welcomeModal.style.display = 'none';
      this.overlaySvg.style.display = 'none';
      this.tooltip.style.display = 'none';
      this.completeModal.style.display = 'none';
    }

    private nextStep() {
      if (this.currentStep < TUTORIAL_STEPS.length) {
        this.showStep(this.currentStep + 1);
      } else {
        this.showComplete();
      }
    }

    private prevStep() {
      if (this.currentStep > 1) {
        this.showStep(this.currentStep - 1);
      } else {
        this.showWelcome();
      }
    }

    private complete() {
      localStorage.setItem('primadopu_tutorial_completed', 'true');
      this.hide();
    }

    private hide() {
      this.hideAllPanels();
      this.container.style.display = 'none';
      this.isActive = false;
      document.body.style.overflow = '';
    }
  }

  // Initialiser le tutoriel quand le DOM est pr√™t
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => new OnboardingTutorial());
  } else {
    new OnboardingTutorial();
  }

  // Exposer une fonction globale pour rejouer le tutoriel (utilis√© par le bouton du profil)
  (window as any).replayTutorial = () => {
    localStorage.removeItem('primadopu_tutorial_completed');
    localStorage.setItem('primadopu_show_tutorial', 'true');
    window.location.href = '/generate';
  };
</script>
