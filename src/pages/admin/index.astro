---
import Layout from "../../layouts/Layout.astro";
import { isAdminUser } from "../../lib/plans";
import { createClerkClient } from "@clerk/astro/server";

const auth = Astro.locals.auth();
const userId = auth.userId;

// V√©rifier l'acc√®s admin
if (!userId || !isAdminUser(userId)) {
  return Astro.redirect("/");
}

// R√©cup√©rer les stats globales via API c√¥t√© serveur
import db from "../../lib/db";

// Stats globales
const totalUsers = db
  .prepare(
    `
  SELECT COUNT(DISTINCT user_id) as count FROM user_credits
`
  )
  .get() as { count: number };

const totalGenerations = db
  .prepare(
    `
  SELECT COUNT(*) as count FROM generations
`
  )
  .get() as { count: number };

const completedGenerations = db
  .prepare(
    `
  SELECT COUNT(*) as count FROM generations WHERE status = 'completed'
`
  )
  .get() as { count: number };

const totalReferences = db
  .prepare(
    `
  SELECT COUNT(*) as count FROM material_refs
`
  )
  .get() as { count: number };

// G√©n√©rations des derni√®res 24h
const recentGenerations = db
  .prepare(
    `
  SELECT COUNT(*) as count FROM generations 
  WHERE created_at >= datetime('now', '-24 hours')
`
  )
  .get() as { count: number };

// G√©n√©rations des 7 derniers jours
const weekGenerations = db
  .prepare(
    `
  SELECT COUNT(*) as count FROM generations 
  WHERE created_at >= datetime('now', '-7 days')
`
  )
  .get() as { count: number };

// R√©partition par plan
const subscriptionStats = db
  .prepare(
    `
  SELECT 
    plan_type,
    COUNT(*) as count,
    SUM(credits_balance) as total_bonus_credits
  FROM subscriptions
  GROUP BY plan_type
`
  )
  .all() as Array<{
  plan_type: string;
  count: number;
  total_bonus_credits: number;
}>;

// Derni√®res g√©n√©rations
const latestGenerations = db
  .prepare(
    `
  SELECT 
    g.id,
    g.user_id,
    g.status,
    g.created_at,
    g.original_image_path,
    g.generated_image_path,
    (SELECT COUNT(*) FROM instructions WHERE generation_id = g.id) as instruction_count
  FROM generations g
  ORDER BY g.created_at DESC
  LIMIT 20
`
  )
  .all() as Array<{
  id: string;
  user_id: string;
  status: string;
  created_at: string;
  original_image_path: string;
  generated_image_path: string | null;
  instruction_count: number;
}>;

// Top utilisateurs (par nombre de g√©n√©rations)
const topUsersRaw = db
  .prepare(
    `
  SELECT 
    uc.user_id,
    uc.total_generations,
    uc.monthly_generations,
    s.plan_type,
    s.credits_balance,
    s.stripe_customer_id,
    (SELECT COUNT(*) FROM material_refs WHERE user_id = uc.user_id) as ref_count
  FROM user_credits uc
  LEFT JOIN subscriptions s ON s.user_id = uc.user_id
  ORDER BY uc.total_generations DESC
  LIMIT 50
`
  )
  .all() as Array<{
  user_id: string;
  total_generations: number;
  monthly_generations: number;
  plan_type: string | null;
  credits_balance: number | null;
  stripe_customer_id: string | null;
  ref_count: number;
}>;

// R√©cup√©rer les emails des utilisateurs depuis Clerk
const userEmails: Record<
  string,
  { email: string; firstName: string | null; lastName: string | null }
> = {};

// R√©cup√©rer les utilisateurs par batch
const userIds = topUsersRaw.map((u) => u.user_id);
try {
  const client = createClerkClient({
    secretKey: import.meta.env.CLERK_SECRET_KEY,
  });
  // R√©cup√©rer tous les utilisateurs en une seule requ√™te
  const clerkUsers = await client.users.getUserList({
    userId: userIds,
    limit: 100,
  });

  for (const user of clerkUsers.data) {
    userEmails[user.id] = {
      email: user.emailAddresses[0]?.emailAddress || "N/A",
      firstName: user.firstName,
      lastName: user.lastName,
    };
  }
} catch (error) {
  console.error("[ADMIN] Erreur r√©cup√©ration emails Clerk:", error);
}

// Enrichir les donn√©es utilisateurs avec les emails
const topUsers = topUsersRaw.map((user) => ({
  ...user,
  email: userEmails[user.user_id]?.email || "N/A",
  firstName: userEmails[user.user_id]?.firstName || "",
  lastName: userEmails[user.user_id]?.lastName || "",
}));

// Achats de cr√©dits r√©cents
const recentPurchases = db
  .prepare(
    `
  SELECT 
    cp.*,
    s.plan_type
  FROM credit_purchases cp
  LEFT JOIN subscriptions s ON s.user_id = cp.user_id
  WHERE cp.status = 'completed'
  ORDER BY cp.created_at DESC
  LIMIT 20
`
  )
  .all() as Array<{
  id: string;
  user_id: string;
  credits_amount: number;
  price_paid: number;
  currency: string;
  status: string;
  created_at: string;
  plan_type: string | null;
}>;

const planLabels: Record<string, string> = {
  free: "Gratuit",
  standard: "Standard",
  pro: "Pro",
};
---

<Layout title="Administration">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
      <div>
        <h1 class="text-3xl font-bold text-slate-900">üõ°Ô∏è Administration</h1>
        <p class="text-slate-600 mt-1">
          Tableau de bord et gestion des utilisateurs
        </p>
      </div>
      <a
        href="/"
        class="text-slate-500 hover:text-slate-700 flex items-center gap-2"
      >
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Retour au site
      </a>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm">
        <div class="text-3xl font-bold text-indigo-600">{totalUsers.count}</div>
        <div class="text-sm text-slate-600">Utilisateurs</div>
      </div>
      <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm">
        <div class="text-3xl font-bold text-green-600">
          {completedGenerations.count}
        </div>
        <div class="text-sm text-slate-600">G√©n√©rations r√©ussies</div>
      </div>
      <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm">
        <div class="text-3xl font-bold text-amber-600">
          {recentGenerations.count}
        </div>
        <div class="text-sm text-slate-600">Derni√®res 24h</div>
      </div>
      <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm">
        <div class="text-3xl font-bold text-purple-600">
          {weekGenerations.count}
        </div>
        <div class="text-sm text-slate-600">7 derniers jours</div>
      </div>
    </div>

    <!-- R√©partition par plan -->
    <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm mb-8">
      <h2 class="text-lg font-semibold mb-4">üìä R√©partition par plan</h2>
      <div class="grid grid-cols-3 gap-4">
        {
          subscriptionStats.map((stat) => (
            <div class="bg-slate-50 rounded-lg p-4 text-center">
              <div class="text-2xl font-bold text-slate-900">{stat.count}</div>
              <div class="text-sm text-slate-600">
                {planLabels[stat.plan_type] || stat.plan_type}
              </div>
              {stat.total_bonus_credits > 0 && (
                <div class="text-xs text-amber-600 mt-1">
                  üíé {stat.total_bonus_credits} cr√©dits bonus
                </div>
              )}
            </div>
          ))
        }
      </div>
    </div>

    <!-- Tabs -->
    <div
      class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden"
    >
      <div class="border-b border-slate-200">
        <nav class="flex" id="admin-tabs">
          <button
            class="tab-btn active px-6 py-4 text-sm font-medium border-b-2 border-indigo-600 text-indigo-600"
            data-tab="users"
          >
            üë• Utilisateurs ({topUsers.length})
          </button>
          <button
            class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-slate-600 hover:text-slate-800"
            data-tab="generations"
          >
            üé® G√©n√©rations ({latestGenerations.length})
          </button>
          <button
            class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-slate-600 hover:text-slate-800"
            data-tab="purchases"
          >
            üí≥ Achats ({recentPurchases.length})
          </button>
        </nav>
      </div>

      <!-- Tab: Utilisateurs -->
      <div id="tab-users" class="tab-content p-6">
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left border-b border-slate-200">
                <th class="pb-3 font-semibold text-slate-700">Utilisateur</th>
                <th class="pb-3 font-semibold text-slate-700">Plan</th>
                <th class="pb-3 font-semibold text-slate-700 text-center"
                  >Total</th
                >
                <th class="pb-3 font-semibold text-slate-700 text-center"
                  >Ce mois</th
                >
                <th class="pb-3 font-semibold text-slate-700 text-center"
                  >Bonus üíé</th
                >
                <th class="pb-3 font-semibold text-slate-700 text-right"
                  >Actions</th
                >
              </tr>
            </thead>
            <tbody>
              {
                topUsers.map((user) => (
                  <tr class="border-b border-slate-100 hover:bg-slate-50">
                    <td class="py-3">
                      <div class="flex flex-col">
                        <span class="font-medium text-slate-900">
                          {user.firstName || user.lastName
                            ? `${user.firstName || ""} ${user.lastName || ""}`.trim()
                            : "Sans nom"}
                        </span>
                        <span class="text-xs text-indigo-600">
                          {user.email}
                        </span>
                        <div class="flex items-center gap-2 mt-1">
                          <span
                            class="font-mono text-xs text-slate-400"
                            title={user.user_id}
                          >
                            {user.user_id.substring(0, 15)}...
                          </span>
                          {user.stripe_customer_id && (
                            <a
                              href={`https://dashboard.stripe.com/customers/${user.stripe_customer_id}`}
                              target="_blank"
                              class="text-xs text-purple-600 hover:underline"
                            >
                              Stripe ‚Üó
                            </a>
                          )}
                        </div>
                      </div>
                    </td>
                    <td class="py-3">
                      <span
                        class:list={[
                          "px-2 py-1 rounded-full text-xs font-medium",
                          user.plan_type === "pro"
                            ? "bg-slate-800 text-white"
                            : user.plan_type === "standard"
                              ? "bg-orange-100 text-orange-700"
                              : "bg-slate-100 text-slate-600",
                        ]}
                      >
                        {planLabels[user.plan_type || "free"] || "Gratuit"}
                      </span>
                    </td>
                    <td class="py-3 text-center font-medium">
                      {user.total_generations}
                    </td>
                    <td class="py-3 text-center">{user.monthly_generations}</td>
                    <td class="py-3 text-center">
                      <span class="inline-flex items-center gap-1 text-amber-600 font-medium">
                        {user.credits_balance || 0}
                      </span>
                    </td>
                    <td class="py-3 text-right">
                      <button
                        class="edit-user-btn px-3 py-1 bg-indigo-100 text-indigo-700 hover:bg-indigo-200 rounded-lg text-xs font-medium transition-colors"
                        data-user-id={user.user_id}
                        data-email={user.email}
                        data-name={
                          `${user.firstName || ""} ${user.lastName || ""}`.trim() ||
                          "Sans nom"
                        }
                        data-plan={user.plan_type || "free"}
                        data-credits={user.credits_balance || 0}
                        data-monthly={user.monthly_generations}
                        data-total={user.total_generations}
                      >
                        ‚úèÔ∏è Modifier
                      </button>
                    </td>
                  </tr>
                ))
              }
            </tbody>
          </table>
        </div>
      </div>

      <!-- Tab: G√©n√©rations -->
      <div id="tab-generations" class="tab-content p-6 hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left border-b border-slate-200">
                <th class="pb-3 font-semibold text-slate-700">ID</th>
                <th class="pb-3 font-semibold text-slate-700">Utilisateur</th>
                <th class="pb-3 font-semibold text-slate-700">Status</th>
                <th class="pb-3 font-semibold text-slate-700 text-center"
                  >Instructions</th
                >
                <th class="pb-3 font-semibold text-slate-700">Date</th>
                <th class="pb-3 font-semibold text-slate-700 text-right"
                  >Images</th
                >
              </tr>
            </thead>
            <tbody>
              {
                latestGenerations.map((gen) => (
                  <tr class="border-b border-slate-100 hover:bg-slate-50">
                    <td class="py-3 font-mono text-xs text-slate-600">
                      {gen.id.substring(0, 8)}...
                    </td>
                    <td class="py-3 font-mono text-xs text-slate-600">
                      {gen.user_id.substring(0, 15)}...
                    </td>
                    <td class="py-3">
                      <span
                        class:list={[
                          "px-2 py-1 rounded-full text-xs font-medium",
                          gen.status === "completed"
                            ? "bg-green-100 text-green-700"
                            : gen.status === "failed"
                              ? "bg-red-100 text-red-700"
                              : gen.status === "processing"
                                ? "bg-blue-100 text-blue-700"
                                : "bg-slate-100 text-slate-600",
                        ]}
                      >
                        {gen.status}
                      </span>
                    </td>
                    <td class="py-3 text-center">{gen.instruction_count}</td>
                    <td class="py-3 text-slate-600">
                      {new Date(gen.created_at).toLocaleDateString("fr-FR", {
                        day: "2-digit",
                        month: "2-digit",
                        hour: "2-digit",
                        minute: "2-digit",
                      })}
                    </td>
                    <td class="py-3 text-right">
                      <div class="flex justify-end gap-2">
                        <a
                          href={`/api/images/${gen.original_image_path}`}
                          target="_blank"
                          class="text-xs text-indigo-600 hover:underline"
                        >
                          Original
                        </a>
                        {gen.generated_image_path && (
                          <a
                            href={`/api/images/${gen.generated_image_path}`}
                            target="_blank"
                            class="text-xs text-green-600 hover:underline"
                          >
                            G√©n√©r√©
                          </a>
                        )}
                      </div>
                    </td>
                  </tr>
                ))
              }
            </tbody>
          </table>
        </div>
      </div>

      <!-- Tab: Achats -->
      <div id="tab-purchases" class="tab-content p-6 hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left border-b border-slate-200">
                <th class="pb-3 font-semibold text-slate-700">ID</th>
                <th class="pb-3 font-semibold text-slate-700">Utilisateur</th>
                <th class="pb-3 font-semibold text-slate-700">Plan</th>
                <th class="pb-3 font-semibold text-slate-700 text-center"
                  >Cr√©dits</th
                >
                <th class="pb-3 font-semibold text-slate-700 text-right"
                  >Prix</th
                >
                <th class="pb-3 font-semibold text-slate-700">Date</th>
              </tr>
            </thead>
            <tbody>
              {
                recentPurchases.map((purchase) => (
                  <tr class="border-b border-slate-100 hover:bg-slate-50">
                    <td class="py-3 font-mono text-xs text-slate-600">
                      {purchase.id.substring(0, 8)}...
                    </td>
                    <td class="py-3 font-mono text-xs text-slate-600">
                      {purchase.user_id.substring(0, 15)}...
                    </td>
                    <td class="py-3">
                      <span
                        class:list={[
                          "px-2 py-1 rounded-full text-xs font-medium",
                          purchase.plan_type === "pro"
                            ? "bg-slate-800 text-white"
                            : purchase.plan_type === "standard"
                              ? "bg-orange-100 text-orange-700"
                              : "bg-slate-100 text-slate-600",
                        ]}
                      >
                        {planLabels[purchase.plan_type || "free"] || "Gratuit"}
                      </span>
                    </td>
                    <td class="py-3 text-center font-medium">
                      üíé +{purchase.credits_amount}
                    </td>
                    <td class="py-3 text-right font-medium">
                      {(purchase.price_paid / 100).toFixed(2)}‚Ç¨
                    </td>
                    <td class="py-3 text-slate-600">
                      {new Date(purchase.created_at).toLocaleDateString(
                        "fr-FR",
                        {
                          day: "2-digit",
                          month: "2-digit",
                          hour: "2-digit",
                          minute: "2-digit",
                        }
                      )}
                    </td>
                  </tr>
                ))
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal d'√©dition utilisateur -->
  <div
    id="edit-modal"
    class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50"
  >
    <div
      class="bg-white rounded-2xl shadow-xl max-w-lg w-full mx-4 p-6 max-h-[90vh] overflow-y-auto"
    >
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-lg font-semibold">‚úèÔ∏è Modifier l'utilisateur</h3>
        <button id="close-modal" class="text-slate-400 hover:text-slate-600">
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <form id="edit-form" class="space-y-5">
        <input type="hidden" id="edit-user-id" name="userId" />

        <!-- Infos utilisateur (lecture seule) -->
        <div class="bg-slate-50 rounded-xl p-4 space-y-2">
          <div class="flex items-center gap-3">
            <div
              class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 font-semibold"
              id="display-avatar"
            >
              ?
            </div>
            <div>
              <div id="display-name" class="font-medium text-slate-900"></div>
              <div id="display-email" class="text-sm text-indigo-600"></div>
            </div>
          </div>
          <div
            id="display-user-id"
            class="font-mono text-xs text-slate-400 break-all mt-2"
          >
          </div>
        </div>

        <!-- Type de plan -->
        <div>
          <label
            class="block text-sm font-medium text-slate-700 mb-2"
            for="edit-plan"
          >
            üìã Type de plan
          </label>
          <select
            id="edit-plan"
            name="planType"
            class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
          >
            <option value="free">Gratuit (3 au total)</option>
            <option value="standard">Standard (25/mois)</option>
            <option value="pro">Pro (50/mois)</option>
          </select>
        </div>

        <!-- Section Cr√©dits -->
        <div class="border border-slate-200 rounded-xl p-4 space-y-4">
          <h4 class="font-medium text-slate-900 flex items-center gap-2">
            üìä Gestion des cr√©dits
          </h4>

          <!-- G√©n√©rations ce mois (pour abonn√©s) -->
          <div>
            <label
              class="block text-sm font-medium text-slate-700 mb-1"
              for="edit-monthly"
            >
              G√©n√©rations ce mois
              <span class="text-xs text-slate-400 font-normal"
                >(utilis√©es sur le quota mensuel)</span
              >
            </label>
            <div class="flex gap-2">
              <input
                type="number"
                id="edit-monthly"
                name="monthlyGenerations"
                min="0"
                class="flex-1 border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
              />
              <button
                type="button"
                class="adjust-btn px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200"
                data-target="edit-monthly"
                data-delta="-1">‚àí1</button
              >
              <button
                type="button"
                class="adjust-btn px-3 py-2 bg-green-100 text-green-600 rounded-lg hover:bg-green-200"
                data-target="edit-monthly"
                data-delta="1">+1</button
              >
              <button
                type="button"
                class="reset-btn px-3 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200"
                data-target="edit-monthly"
                data-value="0">Reset</button
              >
            </div>
            <p class="text-xs text-slate-500 mt-1">
              Pour les abonn√©s: nombre de cr√©dits d√©j√† utilis√©s ce mois. R√©duire
              = donner des cr√©dits.
            </p>
          </div>

          <!-- G√©n√©rations totales (pour gratuits + stats) -->
          <div>
            <label
              class="block text-sm font-medium text-slate-700 mb-1"
              for="edit-total"
            >
              G√©n√©rations totales
              <span class="text-xs text-slate-400 font-normal"
                >(compteur global / limite gratuits)</span
              >
            </label>
            <div class="flex gap-2">
              <input
                type="number"
                id="edit-total"
                name="totalGenerations"
                min="0"
                class="flex-1 border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
              />
              <button
                type="button"
                class="adjust-btn px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200"
                data-target="edit-total"
                data-delta="-1">‚àí1</button
              >
              <button
                type="button"
                class="adjust-btn px-3 py-2 bg-green-100 text-green-600 rounded-lg hover:bg-green-200"
                data-target="edit-total"
                data-delta="1">+1</button
              >
              <button
                type="button"
                class="reset-btn px-3 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200"
                data-target="edit-total"
                data-value="0">Reset</button
              >
            </div>
            <p class="text-xs text-slate-500 mt-1">
              Pour les gratuits: limite de 3. R√©duire √† 0 = redonner 3 cr√©dits
              gratuits.
            </p>
          </div>
        </div>

        <!-- Cr√©dits bonus -->
        <div
          class="border border-amber-200 bg-amber-50 rounded-xl p-4 space-y-4"
        >
          <h4 class="font-medium text-amber-800 flex items-center gap-2">
            üíé Cr√©dits bonus (suppl√©mentaires)
          </h4>

          <div>
            <label
              class="block text-sm font-medium text-slate-700 mb-1"
              for="edit-credits"
            >
              Solde actuel
            </label>
            <div class="flex gap-2">
              <input
                type="number"
                id="edit-credits"
                name="creditsBalance"
                min="0"
                class="flex-1 border border-amber-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-amber-500 focus:border-amber-500 bg-white"
              />
              <button
                type="button"
                class="adjust-btn px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200"
                data-target="edit-credits"
                data-delta="-5">‚àí5</button
              >
              <button
                type="button"
                class="adjust-btn px-3 py-2 bg-green-100 text-green-600 rounded-lg hover:bg-green-200"
                data-target="edit-credits"
                data-delta="5">+5</button
              >
              <button
                type="button"
                class="adjust-btn px-3 py-2 bg-green-100 text-green-600 rounded-lg hover:bg-green-200"
                data-target="edit-credits"
                data-delta="10">+10</button
              >
            </div>
            <p class="text-xs text-amber-700 mt-1">
              Ces cr√©dits n'expirent jamais. Utilis√©s apr√®s le quota mensuel.
            </p>
          </div>
        </div>

        <div class="flex gap-3 pt-4 border-t border-slate-200">
          <button
            type="button"
            id="cancel-modal"
            class="flex-1 px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50"
          >
            Annuler
          </button>
          <button
            type="submit"
            class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium"
          >
            üíæ Sauvegarder
          </button>
        </div>
      </form>

      <!-- Zone de danger - Suppression -->
      <details class="mt-6 border border-red-200 rounded-xl overflow-hidden">
        <summary
          class="px-4 py-3 bg-red-50 text-red-700 cursor-pointer font-medium flex items-center gap-2 hover:bg-red-100"
        >
          ‚ö†Ô∏è Zone de danger
        </summary>
        <div class="p-4 bg-white space-y-4">
          <p class="text-sm text-slate-600">
            La suppression d'un utilisateur est <strong>irr√©versible</strong>.
            Toutes les donn√©es seront d√©finitivement effac√©es :
          </p>
          <ul class="text-sm text-slate-600 list-disc list-inside space-y-1">
            <li>Toutes les g√©n√©rations (images avant/apr√®s)</li>
            <li>Toutes les r√©f√©rences upload√©es</li>
            <li>Tous les dossiers</li>
            <li>L'abonnement et les cr√©dits</li>
            <li>L'historique des achats</li>
          </ul>
          <div class="flex items-center gap-2 p-3 bg-red-50 rounded-lg">
            <input
              type="checkbox"
              id="confirm-delete-checkbox"
              class="w-4 h-4 text-red-600 border-slate-300 rounded focus:ring-red-500"
            />
            <label for="confirm-delete-checkbox" class="text-sm text-red-700">
              Je comprends que cette action est irr√©versible
            </label>
          </div>
          <button
            type="button"
            id="delete-user-btn"
            disabled
            class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-opacity"
          >
            üóëÔ∏è Supprimer d√©finitivement cet utilisateur
          </button>
        </div>
      </details>

      <div id="edit-result" class="mt-4 hidden"></div>
    </div>
  </div>
</Layout>

<style>
  .tab-btn.active {
    border-color: rgb(79 70 229);
    color: rgb(79 70 229);
  }
</style>

<script>
  // Gestion des onglets
  const tabs = document.querySelectorAll<HTMLButtonElement>(".tab-btn");
  const tabContents = document.querySelectorAll(".tab-content");

  tabs.forEach((tab) => {
    tab.addEventListener("click", () => {
      const tabId = tab.getAttribute("data-tab");
      const targetId = `tab-${tabId}`;

      // D√©sactiver tous les onglets
      tabs.forEach((t) =>
        t.classList.remove("active", "border-indigo-600", "text-indigo-600")
      );
      tabContents.forEach((c) => c.classList.add("hidden"));

      // Activer l'onglet cliqu√©
      tab.classList.add("active", "border-indigo-600", "text-indigo-600");
      document.getElementById(targetId)?.classList.remove("hidden");
    });
  });

  // Gestion de la modal d'√©dition
  const modal = document.getElementById("edit-modal");
  const closeModal = document.getElementById("close-modal");
  const cancelModal = document.getElementById("cancel-modal");
  const editForm = document.getElementById("edit-form") as HTMLFormElement;
  const editResult = document.getElementById("edit-result");

  // Inputs
  const editUserIdInput = document.getElementById(
    "edit-user-id"
  ) as HTMLInputElement;
  const displayUserId = document.getElementById("display-user-id");
  const displayName = document.getElementById("display-name");
  const displayEmail = document.getElementById("display-email");
  const displayAvatar = document.getElementById("display-avatar");
  const editPlan = document.getElementById("edit-plan") as HTMLSelectElement;
  const editMonthly = document.getElementById(
    "edit-monthly"
  ) as HTMLInputElement;
  const editTotal = document.getElementById("edit-total") as HTMLInputElement;
  const editCredits = document.getElementById(
    "edit-credits"
  ) as HTMLInputElement;

  // Ouvrir la modal
  document.querySelectorAll(".edit-user-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const el = btn as HTMLElement;
      const userId = el.dataset.userId || "";
      const email = el.dataset.email || "N/A";
      const name = el.dataset.name || "Sans nom";
      const plan = el.dataset.plan || "free";
      const credits = el.dataset.credits || "0";
      const monthly = el.dataset.monthly || "0";
      const total = el.dataset.total || "0";

      // Remplir les champs
      editUserIdInput.value = userId;
      displayUserId!.textContent = userId;
      displayName!.textContent = name;
      displayEmail!.textContent = email;
      displayAvatar!.textContent = name.charAt(0).toUpperCase();
      editPlan.value = plan;
      editMonthly.value = monthly;
      editTotal.value = total;
      editCredits.value = credits;

      // R√©initialiser le r√©sultat
      editResult!.classList.add("hidden");

      modal?.classList.remove("hidden");
      modal?.classList.add("flex");
    });
  });

  // Fermer la modal
  [closeModal, cancelModal].forEach((btn) => {
    btn?.addEventListener("click", () => {
      modal?.classList.add("hidden");
      modal?.classList.remove("flex");
    });
  });

  // Boutons d'ajustement (+/- cr√©dits)
  document.querySelectorAll(".adjust-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const el = btn as HTMLElement;
      const targetId = el.dataset.target;
      const delta = parseInt(el.dataset.delta || "0");
      const target = document.getElementById(targetId!) as HTMLInputElement;

      if (target) {
        const current = parseInt(target.value) || 0;
        target.value = String(Math.max(0, current + delta));
      }
    });
  });

  // Boutons de reset
  document.querySelectorAll(".reset-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const el = btn as HTMLElement;
      const targetId = el.dataset.target;
      const value = el.dataset.value || "0";
      const target = document.getElementById(targetId!) as HTMLInputElement;

      if (target) {
        target.value = value;
      }
    });
  });

  // Soumettre le formulaire
  editForm?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(editForm);
    const data = {
      userId: formData.get("userId"),
      planType: formData.get("planType"),
      monthlyGenerations:
        parseInt(formData.get("monthlyGenerations") as string) || 0,
      totalGenerations:
        parseInt(formData.get("totalGenerations") as string) || 0,
      creditsBalance: parseInt(formData.get("creditsBalance") as string) || 0,
    };

    try {
      const response = await fetch("/api/admin/update-user", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (result.success) {
        editResult!.innerHTML =
          '<div class="bg-green-100 text-green-700 p-3 rounded-lg">‚úÖ Modifications enregistr√©es</div>';
        editResult!.classList.remove("hidden");

        // Recharger la page apr√®s 1s
        setTimeout(() => location.reload(), 1000);
      } else {
        editResult!.innerHTML = `<div class="bg-red-100 text-red-700 p-3 rounded-lg">‚ùå ${result.error}</div>`;
        editResult!.classList.remove("hidden");
      }
    } catch (error) {
      editResult!.innerHTML =
        '<div class="bg-red-100 text-red-700 p-3 rounded-lg">‚ùå Erreur serveur</div>';
      editResult!.classList.remove("hidden");
    }
  });

  // Fermer la modal en cliquant √† l'ext√©rieur
  modal?.addEventListener("click", (e) => {
    if (e.target === modal) {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }
  });

  // ==========================================
  // SUPPRESSION UTILISATEUR
  // ==========================================

  const confirmDeleteCheckbox = document.getElementById(
    "confirm-delete-checkbox"
  ) as HTMLInputElement;
  const deleteUserBtn = document.getElementById(
    "delete-user-btn"
  ) as HTMLButtonElement;

  // Activer/d√©sactiver le bouton de suppression selon la checkbox
  confirmDeleteCheckbox?.addEventListener("change", () => {
    deleteUserBtn.disabled = !confirmDeleteCheckbox.checked;
  });

  // R√©initialiser la checkbox √† l'ouverture de la modal
  document.querySelectorAll(".edit-user-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      if (confirmDeleteCheckbox) {
        confirmDeleteCheckbox.checked = false;
      }
      if (deleteUserBtn) {
        deleteUserBtn.disabled = true;
      }
    });
  });

  // Supprimer l'utilisateur
  deleteUserBtn?.addEventListener("click", async () => {
    const userId = editUserIdInput.value;
    const userName = displayName?.textContent || "cet utilisateur";
    const userEmail = displayEmail?.textContent || "";

    // Double confirmation
    const confirm1 = window.confirm(
      `‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\n` +
        `Vous √™tes sur le point de supprimer d√©finitivement:\n` +
        `${userName} (${userEmail})\n\n` +
        `Cette action est IRR√âVERSIBLE.\n\n` +
        `Continuer ?`
    );

    if (!confirm1) return;

    // Triple confirmation avec saisie
    const confirm2 = window.prompt(
      `Pour confirmer la suppression, tapez "SUPPRIMER" en majuscules:`
    );

    if (confirm2 !== "SUPPRIMER") {
      alert("Suppression annul√©e.");
      return;
    }

    try {
      deleteUserBtn.disabled = true;
      deleteUserBtn.textContent = "‚è≥ Suppression en cours...";

      const response = await fetch("/api/admin/delete-user", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId, confirmDelete: true }),
      });

      const result = await response.json();

      if (result.success) {
        editResult!.innerHTML = `
          <div class="bg-green-100 text-green-700 p-3 rounded-lg">
            ‚úÖ Utilisateur supprim√© avec succ√®s<br>
            <span class="text-xs">
              ${result.stats.generations} g√©n√©ration(s), 
              ${result.stats.references} r√©f√©rence(s), 
              ${result.stats.folders} dossier(s) supprim√©(s)
            </span>
          </div>
        `;
        editResult!.classList.remove("hidden");

        // Recharger la page apr√®s 2s
        setTimeout(() => location.reload(), 2000);
      } else {
        editResult!.innerHTML = `<div class="bg-red-100 text-red-700 p-3 rounded-lg">‚ùå ${result.error}</div>`;
        editResult!.classList.remove("hidden");
        deleteUserBtn.disabled = false;
        deleteUserBtn.textContent =
          "üóëÔ∏è Supprimer d√©finitivement cet utilisateur";
      }
    } catch (error) {
      editResult!.innerHTML =
        '<div class="bg-red-100 text-red-700 p-3 rounded-lg">‚ùå Erreur serveur</div>';
      editResult!.classList.remove("hidden");
      deleteUserBtn.disabled = false;
      deleteUserBtn.textContent = "üóëÔ∏è Supprimer d√©finitivement cet utilisateur";
    }
  });
</script>
