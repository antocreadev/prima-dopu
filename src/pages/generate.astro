---
import Layout from "../layouts/Layout.astro";
import { SignedIn, SignedOut } from "@clerk/astro/components";
import ShareButtons from "../components/ShareButtons.astro";
import {
  getUserReferences,
  getUserFolders,
  getCreditStats,
  canUserGenerate,
  type PlanType,
} from "../lib/db";
import { getUserPlanFromAuth } from "../lib/plans";

const auth = Astro.locals.auth();
const userId = auth.userId;

if (!userId) {
  return Astro.redirect("/");
}

// D√©terminer le plan de l'utilisateur
const userPlanInfo = getUserPlanFromAuth(auth.has as any, userId);
const creditStats = getCreditStats(userId, userPlanInfo.planType);
const creditCheck = canUserGenerate(userId, userPlanInfo.planType);

// Rediriger si plus de cr√©dits
if (!creditCheck.canGenerate) {
  return Astro.redirect("/no-credits");
}

const references = getUserReferences(userId);
const folders = getUserFolders(userId);

// Organiser les r√©f√©rences par dossier
const refsWithoutFolder = references.filter((r) => !r.folder_id);
const refsByFolder: Record<string, typeof references> = {};
folders.forEach((f) => {
  refsByFolder[f.id] = references.filter((r) => r.folder_id === f.id);
});
---

<Layout title="G√©n√©rer">
  <SignedOut>
    <div class="text-center py-20">
      <p class="text-slate-600">
        Veuillez vous connecter pour acc√©der √† cette page.
      </p>
    </div>
  </SignedOut>
  <SignedIn>
    <div class="max-w-4xl mx-auto">
      <!-- En-t√™te avec cr√©dits -->
      <div
        class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8"
      >
        <div>
          <h1 class="text-3xl font-bold mb-2">Nouvelle g√©n√©ration</h1>
          <p class="text-slate-600">
            Cr√©ez votre visualisation avant/apr√®s en quelques √©tapes
          </p>
        </div>

        <!-- Badge des cr√©dits -->
        <div
          class:list={[
            "flex items-center gap-3 px-4 py-3 rounded-xl border",
            creditStats.remaining <= 2
              ? "bg-orange-50 border-orange-200"
              : "bg-slate-50 border-slate-200",
          ]}
        >
          <div class="text-center">
            <div
              class:list={[
                "text-2xl font-bold",
                creditStats.remaining === 0
                  ? "text-red-600"
                  : creditStats.remaining <= 2
                    ? "text-orange-600"
                    : "text-slate-900",
              ]}
            >
              {creditStats.remaining}
            </div>
            <div class="text-xs text-slate-500">
              restant{creditStats.remaining > 1 ? "s" : ""}
            </div>
          </div>
          <div class="w-px h-8 bg-slate-300"></div>
          <div class="text-sm">
            <div class="font-medium text-slate-800">
              Plan {creditStats.planName}
            </div>
            <a href="/pricing" class="text-orange-600 hover:underline text-xs">
              {userPlanInfo.isPaid ? "G√©rer" : "Upgrader"}
            </a>
          </div>
        </div>
      </div>

      <!-- Indicateur d'√©tapes -->
      <div class="flex items-center justify-center mb-8">
        <div class="flex items-center">
          <div
            id="step1Indicator"
            class="w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold"
          >
            1
          </div>
          <div class="w-24 h-1 bg-slate-200" id="step1Line"></div>
          <div
            id="step2Indicator"
            class="w-10 h-10 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center font-bold"
          >
            2
          </div>
          <div class="w-24 h-1 bg-slate-200" id="step2Line"></div>
          <div
            id="step3Indicator"
            class="w-10 h-10 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center font-bold"
          >
            3
          </div>
        </div>
      </div>

      <!-- √âtape 1: Upload photo -->
      <div id="step1" class="bg-white rounded-xl border border-slate-200 p-6">
        <h2 class="text-xl font-semibold mb-4">
          üì∏ √âtape 1 : T√©l√©chargez votre photo
        </h2>
        <p class="text-slate-600 mb-4">
          S√©lectionnez une photo de l'espace que vous souhaitez transformer
        </p>

        <!-- Conseil photo horizontale -->
        <div
          class="mb-6 p-4 bg-amber-50 border border-amber-200 rounded-xl flex items-center gap-4"
        >
          <div class="phone-rotate-animation flex-shrink-0">
            <div class="phone-icon">
              <svg
                width="40"
                height="60"
                viewBox="0 0 40 60"
                class="text-amber-600"
              >
                <rect
                  x="4"
                  y="4"
                  width="32"
                  height="52"
                  rx="4"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"></rect>
                <circle cx="20" cy="50" r="3" fill="currentColor"></circle>
                <rect
                  x="14"
                  y="8"
                  width="12"
                  height="2"
                  rx="1"
                  fill="currentColor"></rect>
              </svg>
            </div>
          </div>
          <div>
            <p class="font-medium text-amber-800">
              üì± Conseil : Prenez la photo en mode paysage
            </p>
            <p class="text-sm text-amber-700 mt-1">
              Tournez votre t√©l√©phone √† l'horizontale pour de meilleurs
              r√©sultats
            </p>
          </div>
        </div>

        <style>
          .phone-rotate-animation {
            animation: rotatePhone 2s ease-in-out infinite;
          }
          @keyframes rotatePhone {
            0%,
            100% {
              transform: rotate(0deg);
            }
            30%,
            70% {
              transform: rotate(-90deg);
            }
          }
          .phone-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
          }
        </style>

        <div
          class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:border-indigo-400 transition-colors"
          id="dropZone"
        >
          <input type="file" id="imageInput" accept="image/*" class="hidden" />
          <div id="uploadPlaceholder">
            <div class="text-5xl mb-4">üì∑</div>
            <p class="text-slate-600 mb-2">Glissez-d√©posez une image ici</p>
            <p class="text-slate-400 text-sm mb-4">ou</p>
            <button
              type="button"
              id="selectImageBtn"
              class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
            >
              S√©lectionner une image
            </button>
          </div>
          <div id="imagePreview" class="hidden">
            <img
              id="previewImg"
              src=""
              alt="Aper√ßu"
              class="max-h-64 mx-auto rounded-lg"
            />
            <button
              type="button"
              id="changeImageBtn"
              class="mt-4 px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors"
            >
              Changer l'image
            </button>
          </div>
        </div>

        <div class="mt-6 flex justify-end">
          <button
            type="button"
            id="toStep2Btn"
            class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            Continuer ‚Üí
          </button>
        </div>
      </div>

      <!-- √âtape 2: Instructions -->
      <div
        id="step2"
        class="bg-white rounded-xl border border-slate-200 p-6 hidden"
      >
        <h2 class="text-xl font-semibold mb-4">
          üé® √âtape 2 : Ajoutez vos instructions
        </h2>
        <p class="text-slate-600 mb-6">
          D√©finissez les modifications √† appliquer √† chaque zone
        </p>

        <div class="grid md:grid-cols-2 gap-6 mb-6">
          <!-- Aper√ßu image -->
          <div>
            <h3 class="font-medium text-slate-700 mb-2">Votre image</h3>
            <img
              id="step2PreviewImg"
              src=""
              alt="Image originale"
              class="w-full rounded-lg border border-slate-200"
            />
          </div>

          <!-- Liste des instructions -->
          <div>
            <div class="flex justify-between items-center mb-2">
              <h3 class="font-medium text-slate-700">Instructions</h3>
              <button
                type="button"
                id="addInstructionBtn"
                class="text-indigo-600 hover:text-indigo-700 text-sm font-medium"
              >
                + Ajouter une instruction
              </button>
            </div>

            <div
              id="instructionsList"
              class="space-y-3 max-h-80 overflow-y-auto"
            >
              <!-- Les instructions seront ajout√©es ici dynamiquement -->
            </div>

            <div id="noInstructions" class="text-center py-8 text-slate-400">
              Aucune instruction. Cliquez sur "Ajouter une instruction" pour
              commencer.
            </div>
          </div>
        </div>

        <div class="mt-6 flex justify-between">
          <button
            type="button"
            id="backToStep1Btn"
            class="px-6 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors"
          >
            ‚Üê Retour
          </button>
          <button
            type="button"
            id="toStep3Btn"
            class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            G√©n√©rer ‚Üí
          </button>
        </div>
      </div>

      <!-- √âtape 3: R√©sultat -->
      <div
        id="step3"
        class="bg-white rounded-xl border border-slate-200 p-6 hidden"
      >
        <h2 class="text-xl font-semibold mb-4">‚ú® √âtape 3 : R√©sultat</h2>

        <div id="generatingState" class="text-center py-12">
          <!-- Loader anim√© -->
          <div class="relative w-24 h-24 mx-auto mb-6">
            <div
              class="absolute inset-0 rounded-full border-4 border-slate-200"
            >
            </div>
            <div
              class="absolute inset-0 rounded-full border-4 border-indigo-600 border-t-transparent animate-spin"
            >
            </div>
            <div
              class="absolute inset-3 rounded-full border-4 border-purple-400 border-b-transparent animate-spin"
              style="animation-direction: reverse; animation-duration: 1.5s;"
            >
            </div>
            <div
              class="absolute inset-0 flex items-center justify-center text-3xl"
            >
              üé®
            </div>
          </div>

          <p class="text-lg font-medium text-slate-800 mb-2">
            G√©n√©ration en cours...
          </p>

          <!-- √âtapes de progression -->
          <div
            id="generationSteps"
            class="max-w-lg mx-auto mt-6 text-left space-y-1"
          >
            <div
              id="step-upload"
              class="flex items-center gap-3 p-3 rounded-xl bg-white border border-slate-200 shadow-sm transition-all duration-300"
            >
              <div
                class="step-icon w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center"
              >
                <span class="text-sm">‚è≥</span>
              </div>
              <div class="flex-1">
                <span class="text-sm font-medium text-slate-700"
                  >Envoi des images</span
                >
                <p class="text-xs text-slate-400">
                  T√©l√©chargement vers le cloud
                </p>
              </div>
              <div class="step-status"></div>
            </div>
            <div
              id="step-analyze"
              class="flex items-center gap-3 p-3 rounded-xl bg-white border border-slate-200 shadow-sm opacity-50 transition-all duration-300"
            >
              <div
                class="step-icon w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center"
              >
                <span class="text-sm">‚è≥</span>
              </div>
              <div class="flex-1">
                <span class="text-sm font-medium text-slate-700"
                  >Analyse IA</span
                >
                <p class="text-xs text-slate-400">Compr√©hension de l'espace</p>
              </div>
              <div class="step-status"></div>
            </div>
            <div
              id="step-plan"
              class="flex items-center gap-3 p-3 rounded-xl bg-white border border-slate-200 shadow-sm opacity-50 transition-all duration-300"
            >
              <div
                class="step-icon w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center"
              >
                <span class="text-sm">‚è≥</span>
              </div>
              <div class="flex-1">
                <span class="text-sm font-medium text-slate-700"
                  >Planification</span
                >
                <p class="text-xs text-slate-400">Mapping des modifications</p>
              </div>
              <div class="step-status"></div>
            </div>
            <div
              id="step-generate"
              class="flex items-center gap-3 p-3 rounded-xl bg-white border border-slate-200 shadow-sm opacity-50 transition-all duration-300"
            >
              <div
                class="step-icon w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center"
              >
                <span class="text-sm">‚è≥</span>
              </div>
              <div class="flex-1">
                <span class="text-sm font-medium text-slate-700"
                  >G√©n√©ration</span
                >
                <p class="text-xs text-slate-400">Cr√©ation de l'image finale</p>
              </div>
              <div class="step-status"></div>
            </div>
          </div>

          <p class="text-xs text-slate-400 mt-6">
            Cela peut prendre jusqu'√† 2 minutes
          </p>
        </div>

        <div id="resultState" class="hidden">
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <h3 class="font-medium text-slate-700 mb-2">Avant</h3>
              <img
                id="resultBeforeImg"
                src=""
                alt="Avant"
                class="w-full rounded-lg border border-slate-200"
              />
            </div>
            <div>
              <h3 class="font-medium text-slate-700 mb-2">
                Apr√®s (g√©n√©r√© par IA)
              </h3>
              <img
                id="resultAfterImg"
                src=""
                alt="Apr√®s"
                class="w-full rounded-lg border border-slate-200 hidden"
              />
              <div
                id="resultDescription"
                class="prose prose-sm max-w-none p-4 bg-slate-50 rounded-lg border border-slate-200 max-h-80 overflow-y-auto hidden"
              >
              </div>
            </div>
          </div>

          <!-- Boutons de partage -->
          <div class="mt-6 p-4 bg-slate-50 rounded-xl border border-slate-200">
            <h4
              class="text-sm font-medium text-slate-700 mb-3 flex items-center gap-2"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"
                ></path>
              </svg>
              Partager votre cr√©ation
            </h4>
            <div
              id="shareButtonsContainer"
              class="share-buttons flex flex-wrap gap-2"
            >
              <!-- Les boutons seront inject√©s dynamiquement via JS -->
            </div>
          </div>

          <div class="mt-6 flex justify-between">
            <a
              href="/history"
              class="px-6 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors"
            >
              Voir l'historique
            </a>
            <button
              type="button"
              id="newGenerationBtn"
              class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors"
            >
              Nouvelle g√©n√©ration
            </button>
          </div>
        </div>

        <div id="errorState" class="hidden text-center py-12">
          <div class="text-5xl mb-4">‚ùå</div>
          <p class="text-lg text-red-600">Une erreur est survenue</p>
          <p id="errorMessage" class="text-sm text-slate-400 mt-2"></p>
          <button
            type="button"
            id="retryBtn"
            class="mt-4 px-6 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors"
          >
            R√©essayer
          </button>
        </div>
      </div>

      <!-- Modal d'ajout d'instruction -->
      <div
        id="instructionModal"
        class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50"
      >
        <div
          class="bg-white rounded-xl p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto"
        >
          <h2 class="text-xl font-semibold mb-4">Ajouter une instruction</h2>

          <div class="mb-4">
            <label class="block text-sm font-medium text-slate-700 mb-2">
              Zone √† modifier *
            </label>
            <input
              type="text"
              id="instructionLocation"
              placeholder="Ex: tout le sol, mur de droite, tous les murs..."
              class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            />

            <!-- Suggestions rapides -->
            <div class="mt-2 flex flex-wrap gap-1">
              <button
                type="button"
                class="zone-suggestion px-2 py-1 text-xs bg-slate-100 hover:bg-slate-200 rounded-full text-slate-600"
                data-zone="tout le sol"
              >
                üü´ Sol complet
              </button>
              <button
                type="button"
                class="zone-suggestion px-2 py-1 text-xs bg-slate-100 hover:bg-slate-200 rounded-full text-slate-600"
                data-zone="mur de gauche"
              >
                ‚¨ÖÔ∏è Mur gauche
              </button>
              <button
                type="button"
                class="zone-suggestion px-2 py-1 text-xs bg-slate-100 hover:bg-slate-200 rounded-full text-slate-600"
                data-zone="mur de droite"
              >
                ‚û°Ô∏è Mur droite
              </button>
              <button
                type="button"
                class="zone-suggestion px-2 py-1 text-xs bg-slate-100 hover:bg-slate-200 rounded-full text-slate-600"
                data-zone="mur du fond"
              >
                ‚¨ÜÔ∏è Mur fond
              </button>
              <button
                type="button"
                class="zone-suggestion px-2 py-1 text-xs bg-slate-100 hover:bg-slate-200 rounded-full text-slate-600"
                data-zone="plafond"
              >
                üîù Plafond
              </button>
            </div>

            <div class="mt-2 text-xs text-slate-500">
              <p class="font-medium mb-1">
                üí° Conseils pour de meilleurs r√©sultats :
              </p>
              <ul class="list-disc list-inside space-y-0.5">
                <li>
                  <strong>Soyez pr√©cis</strong> : "mur de droite" plut√¥t que "mur"
                </li>
                <li>
                  <strong>Une zone par instruction</strong> : cr√©ez une instruction
                  par zone
                </li>
                <li>
                  <strong>Pour le sol</strong> : pr√©cisez "pose horizontale" ou "pose
                  verticale" si souhait√©
                </li>
              </ul>
            </div>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-medium text-slate-700 mb-2">
              R√©f√©rence *
            </label>

            <div class="mb-3">
              <div class="flex gap-2 mb-2">
                <button
                  type="button"
                  id="useLibraryBtn"
                  class="flex-1 px-3 py-2 border-2 border-indigo-500 bg-indigo-50 text-indigo-700 rounded-lg text-sm font-medium"
                >
                  üìö Biblioth√®que
                </button>
                <button
                  type="button"
                  id="useNewBtn"
                  class="flex-1 px-3 py-2 border-2 border-slate-200 text-slate-600 rounded-lg text-sm font-medium hover:border-slate-300"
                >
                  üì∑ Nouvelle
                </button>
              </div>
            </div>

            <!-- S√©lection depuis la biblioth√®que -->
            <div id="librarySelection">
              {
                references.length > 0 ? (
                  <div>
                    {/* Tabs des dossiers */}
                    <div class="flex gap-1 mb-3 overflow-x-auto pb-2 scrollbar-hide">
                      <button
                        type="button"
                        class="folder-tab px-3 py-1.5 text-xs rounded-full whitespace-nowrap bg-indigo-100 text-indigo-700 font-medium"
                        data-folder="all"
                      >
                        üìö Tout ({references.length})
                      </button>
                      {refsWithoutFolder.length > 0 && (
                        <button
                          type="button"
                          class="folder-tab px-3 py-1.5 text-xs rounded-full whitespace-nowrap bg-slate-100 text-slate-600 hover:bg-slate-200"
                          data-folder="none"
                        >
                          üìÑ Sans dossier ({refsWithoutFolder.length})
                        </button>
                      )}
                      {folders.map(
                        (folder) =>
                          refsByFolder[folder.id]?.length > 0 && (
                            <button
                              type="button"
                              class="folder-tab px-3 py-1.5 text-xs rounded-full whitespace-nowrap bg-slate-100 text-slate-600 hover:bg-slate-200 flex items-center gap-1"
                              data-folder={folder.id}
                            >
                              <span
                                class="w-2 h-2 rounded-sm"
                                style={`background-color: ${folder.color}`}
                              />
                              {folder.name} (
                              {refsByFolder[folder.id]?.length || 0})
                            </button>
                          )
                      )}
                    </div>

                    {/* Grille toutes les r√©f√©rences */}
                    <div
                      id="refs-all"
                      class="refs-grid grid grid-cols-3 gap-2 max-h-48 overflow-y-auto p-1"
                    >
                      {references.map((ref) => (
                        <label
                          class="cursor-pointer ref-item"
                          data-folder={ref.folder_id || "none"}
                        >
                          <input
                            type="radio"
                            name="selectedReference"
                            value={ref.id}
                            data-path={ref.image_path}
                            data-name={ref.name || ""}
                            class="hidden peer"
                          />
                          <div class="peer-checked:ring-2 peer-checked:ring-indigo-500 rounded-lg overflow-hidden border border-slate-200">
                            <img
                              src={`/api/images/${ref.image_path.replace("/uploads/", "").replace("/uploads", "").replace(/^\//, "")}`}
                              alt={ref.name || "R√©f√©rence"}
                              class="w-full aspect-square object-cover"
                            />
                            <p class="p-1 text-xs truncate text-center">
                              {ref.name || "Sans nom"}
                            </p>
                          </div>
                        </label>
                      ))}
                    </div>
                  </div>
                ) : (
                  <div class="text-center py-4 text-slate-400 text-sm">
                    Aucune r√©f√©rence dans votre biblioth√®que.
                    <a
                      href="/library"
                      class="text-indigo-600 hover:underline block mt-1"
                    >
                      Ajouter des r√©f√©rences
                    </a>
                  </div>
                )
              }
            </div>

            <!-- Upload nouvelle r√©f√©rence -->
            <div id="newReferenceUpload" class="hidden">
              <input
                type="file"
                id="newReferenceInput"
                accept="image/*"
                class="hidden"
              />
              <div
                id="newRefDropZone"
                class="border-2 border-dashed border-slate-300 rounded-lg p-4 text-center cursor-pointer hover:border-indigo-400 transition-colors"
              >
                <div id="newRefPlaceholder">
                  <p class="text-slate-600 text-sm">
                    Cliquez ou glissez une image
                  </p>
                </div>
                <div id="newRefPreview" class="hidden">
                  <img
                    id="newRefPreviewImg"
                    src=""
                    alt="Aper√ßu"
                    class="max-h-24 mx-auto rounded"
                  />
                </div>
              </div>
              <div class="mt-2">
                <label class="block text-xs text-slate-500 mb-1"
                  >Nom et description (aide l'IA √† comprendre)</label
                >
                <input
                  type="text"
                  id="newReferenceName"
                  placeholder="Ex: Parquet ch√™ne clair, Carrelage m√©tro blanc, Peinture gris anthracite..."
                  class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                />
              </div>
            </div>
          </div>

          <div class="flex gap-3">
            <button
              type="button"
              id="cancelInstructionBtn"
              class="flex-1 px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors"
            >
              Annuler
            </button>
            <button
              type="button"
              id="confirmInstructionBtn"
              class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
            >
              Ajouter
            </button>
          </div>
        </div>
      </div>
    </div>
  </SignedIn>
</Layout>

<script>
  interface Instruction {
    id: string;
    location: string;
    referenceId?: string;
    referencePath: string;
    referenceName?: string;
    isNew?: boolean;
    newFile?: File;
  }

  let currentStep = 1;
  let selectedImage: File | null = null;
  let instructions: Instruction[] = [];
  let useLibrary = true;
  let newReferenceFile: File | null = null;

  // √âl√©ments DOM
  const step1 = document.getElementById("step1")!;
  const step2 = document.getElementById("step2")!;
  const step3 = document.getElementById("step3")!;
  const imageInput = document.getElementById("imageInput") as HTMLInputElement;
  const selectImageBtn = document.getElementById("selectImageBtn")!;
  const dropZone = document.getElementById("dropZone")!;
  const uploadPlaceholder = document.getElementById("uploadPlaceholder")!;
  const imagePreview = document.getElementById("imagePreview")!;
  const previewImg = document.getElementById("previewImg") as HTMLImageElement;
  const changeImageBtn = document.getElementById("changeImageBtn")!;
  const toStep2Btn = document.getElementById("toStep2Btn") as HTMLButtonElement;
  const step2PreviewImg = document.getElementById(
    "step2PreviewImg"
  ) as HTMLImageElement;
  const backToStep1Btn = document.getElementById("backToStep1Btn")!;
  const toStep3Btn = document.getElementById("toStep3Btn") as HTMLButtonElement;
  const addInstructionBtn = document.getElementById("addInstructionBtn")!;
  const instructionsList = document.getElementById("instructionsList")!;
  const noInstructions = document.getElementById("noInstructions")!;
  const instructionModal = document.getElementById("instructionModal")!;
  const instructionLocation = document.getElementById(
    "instructionLocation"
  ) as HTMLInputElement;
  const useLibraryBtn = document.getElementById("useLibraryBtn")!;
  const useNewBtn = document.getElementById("useNewBtn")!;
  const librarySelection = document.getElementById("librarySelection")!;
  const newReferenceUpload = document.getElementById("newReferenceUpload")!;
  const newReferenceInput = document.getElementById(
    "newReferenceInput"
  ) as HTMLInputElement;
  const newRefDropZone = document.getElementById("newRefDropZone")!;
  const newRefPlaceholder = document.getElementById("newRefPlaceholder")!;
  const newRefPreview = document.getElementById("newRefPreview")!;
  const newRefPreviewImg = document.getElementById(
    "newRefPreviewImg"
  ) as HTMLImageElement;
  const newReferenceName = document.getElementById(
    "newReferenceName"
  ) as HTMLInputElement;
  const cancelInstructionBtn = document.getElementById("cancelInstructionBtn")!;
  const confirmInstructionBtn = document.getElementById(
    "confirmInstructionBtn"
  )!;
  const generatingState = document.getElementById("generatingState")!;
  const resultState = document.getElementById("resultState")!;
  const errorState = document.getElementById("errorState")!;
  const resultBeforeImg = document.getElementById(
    "resultBeforeImg"
  ) as HTMLImageElement;
  const resultAfterImg = document.getElementById(
    "resultAfterImg"
  ) as HTMLImageElement;
  const resultDescription = document.getElementById("resultDescription")!;
  const errorMessage = document.getElementById("errorMessage")!;
  const newGenerationBtn = document.getElementById("newGenerationBtn")!;
  const retryBtn = document.getElementById("retryBtn")!;

  // Indicateurs
  const step1Indicator = document.getElementById("step1Indicator")!;
  const step2Indicator = document.getElementById("step2Indicator")!;
  const step3Indicator = document.getElementById("step3Indicator")!;
  const step1Line = document.getElementById("step1Line")!;
  const step2Line = document.getElementById("step2Line")!;

  function updateStepIndicators() {
    step1Indicator.className =
      currentStep >= 1
        ? "w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold"
        : "w-10 h-10 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center font-bold";
    step2Indicator.className =
      currentStep >= 2
        ? "w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold"
        : "w-10 h-10 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center font-bold";
    step3Indicator.className =
      currentStep >= 3
        ? "w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold"
        : "w-10 h-10 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center font-bold";
    step1Line.className =
      currentStep >= 2 ? "w-24 h-1 bg-indigo-600" : "w-24 h-1 bg-slate-200";
    step2Line.className =
      currentStep >= 3 ? "w-24 h-1 bg-indigo-600" : "w-24 h-1 bg-slate-200";
  }

  function goToStep(step: number) {
    currentStep = step;
    step1.classList.toggle("hidden", step !== 1);
    step2.classList.toggle("hidden", step !== 2);
    step3.classList.toggle("hidden", step !== 3);
    updateStepIndicators();
  }

  // √âtape 1 - Upload image
  selectImageBtn.addEventListener("click", () => imageInput.click());
  changeImageBtn.addEventListener("click", () => imageInput.click());

  imageInput.addEventListener("change", (e) => {
    const file = (e.target as HTMLInputElement).files?.[0];
    if (file) handleImageSelect(file);
  });

  dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.classList.add("border-indigo-400", "bg-indigo-50");
  });

  dropZone.addEventListener("dragleave", () => {
    dropZone.classList.remove("border-indigo-400", "bg-indigo-50");
  });

  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("border-indigo-400", "bg-indigo-50");
    const file = e.dataTransfer?.files?.[0];
    if (file && isImageFile(file)) handleImageSelect(file);
  });

  // Fonction helper pour convertir les chemins d'images vers l'API
  function getImageUrl(path: string): string {
    if (!path) return "";
    if (path.startsWith("blob:") || path.startsWith("data:")) {
      return path; // URL blob ou data URL - pas de conversion
    }
    // Nettoyer le chemin
    let cleanPath = path.replace("/uploads/", "/").replace("/uploads", "");
    // Retirer le / initial pour √©viter le double slash
    if (cleanPath.startsWith("/")) cleanPath = cleanPath.slice(1);
    return `/api/images/${cleanPath}`;
  }

  // V√©rifie si c'est un fichier image (inclut HEIC/HEIF)
  function isImageFile(file: File): boolean {
    const ext = file.name.toLowerCase().split(".").pop() || "";
    const imageExts = [
      "jpg",
      "jpeg",
      "png",
      "gif",
      "webp",
      "heic",
      "heif",
      "hif",
      "bmp",
      "tiff",
    ];
    return file.type.startsWith("image/") || imageExts.includes(ext);
  }

  // V√©rifie si c'est un format Apple n√©cessitant conversion
  function isAppleFormat(file: File): boolean {
    const ext = file.name.toLowerCase().split(".").pop() || "";
    return ["heic", "heif", "hif"].includes(ext);
  }

  async function handleImageSelect(file: File) {
    selectedImage = file;

    // Pour les formats Apple (HEIC/HEIF), convertir via l'API pour l'aper√ßu
    if (isAppleFormat(file)) {
      uploadPlaceholder.innerHTML =
        '<div class="text-5xl mb-4">üîÑ</div><p class="text-slate-600">Conversion en cours...</p>';

      try {
        const formData = new FormData();
        formData.append("image", file);

        const response = await fetch("/api/convert-image", {
          method: "POST",
          body: formData,
        });

        if (!response.ok) throw new Error("√âchec de la conversion");

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        previewImg.src = url;
        step2PreviewImg.src = url;
      } catch (error) {
        console.error("Erreur conversion aper√ßu:", error);
        // Fallback: afficher un placeholder
        previewImg.src = "";
        previewImg.alt =
          "Format HEIC - Aper√ßu non disponible (la g√©n√©ration fonctionnera)";
      }
    } else {
      const url = URL.createObjectURL(file);
      previewImg.src = url;
      step2PreviewImg.src = url;
    }

    uploadPlaceholder.innerHTML = `
      <div class="text-5xl mb-4">üì∑</div>
      <p class="text-slate-600 mb-2">Glissez-d√©posez une image ici</p>
      <p class="text-slate-400 text-sm mb-4">ou</p>
      <button
        type="button"
        id="selectImageBtn"
        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
      >
        S√©lectionner une image
      </button>
    `;
    uploadPlaceholder.classList.add("hidden");
    imagePreview.classList.remove("hidden");
    toStep2Btn.disabled = false;
  }

  toStep2Btn.addEventListener("click", () => goToStep(2));
  backToStep1Btn.addEventListener("click", () => goToStep(1));

  // √âtape 2 - Instructions
  function updateInstructionsList() {
    if (instructions.length === 0) {
      noInstructions.classList.remove("hidden");
      instructionsList.innerHTML = "";
      toStep3Btn.disabled = true;
    } else {
      noInstructions.classList.add("hidden");
      toStep3Btn.disabled = false;
      instructionsList.innerHTML = instructions
        .map(
          (instr, idx) => `
        <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg">
          <img src="${getImageUrl(instr.referencePath)}" alt="R√©f√©rence" class="w-12 h-12 rounded object-cover" />
          <div class="flex-1 min-w-0">
            <p class="font-medium text-slate-800 truncate">${instr.location}</p>
            <p class="text-sm text-slate-500 truncate">${instr.referenceName || "Sans nom"}</p>
          </div>
          <button type="button" class="delete-instruction p-2 text-red-500 hover:bg-red-50 rounded-lg" data-idx="${idx}">
            üóëÔ∏è
          </button>
        </div>
      `
        )
        .join("");

      document.querySelectorAll(".delete-instruction").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const idx = parseInt(
            (e.currentTarget as HTMLElement).dataset.idx || "0"
          );
          instructions.splice(idx, 1);
          updateInstructionsList();
        });
      });
    }
  }

  addInstructionBtn.addEventListener("click", () => {
    instructionLocation.value = "";
    newReferenceName.value = "";
    newReferenceFile = null;
    newRefPlaceholder.classList.remove("hidden");
    newRefPreview.classList.add("hidden");
    document
      .querySelectorAll('input[name="selectedReference"]')
      .forEach((el) => {
        (el as HTMLInputElement).checked = false;
      });
    useLibrary = true;
    useLibraryBtn.className =
      "flex-1 px-3 py-2 border-2 border-indigo-500 bg-indigo-50 text-indigo-700 rounded-lg text-sm font-medium";
    useNewBtn.className =
      "flex-1 px-3 py-2 border-2 border-slate-200 text-slate-600 rounded-lg text-sm font-medium hover:border-slate-300";
    librarySelection.classList.remove("hidden");
    newReferenceUpload.classList.add("hidden");
    instructionModal.classList.remove("hidden");
    instructionModal.classList.add("flex");

    // Ajouter les gestionnaires pour les suggestions de zone
    document.querySelectorAll(".zone-suggestion").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const zone = (e.currentTarget as HTMLElement).dataset.zone || "";
        instructionLocation.value = zone;
        instructionLocation.focus();
      });
    });
  });

  useLibraryBtn.addEventListener("click", () => {
    useLibrary = true;
    useLibraryBtn.className =
      "flex-1 px-3 py-2 border-2 border-indigo-500 bg-indigo-50 text-indigo-700 rounded-lg text-sm font-medium";
    useNewBtn.className =
      "flex-1 px-3 py-2 border-2 border-slate-200 text-slate-600 rounded-lg text-sm font-medium hover:border-slate-300";
    librarySelection.classList.remove("hidden");
    newReferenceUpload.classList.add("hidden");
  });

  // Gestion des tabs de dossiers dans la modal
  const folderTabs = document.querySelectorAll(".folder-tab");
  const refItems = document.querySelectorAll(".ref-item");

  folderTabs.forEach((tab) => {
    tab.addEventListener("click", () => {
      const folderId = (tab as HTMLElement).dataset.folder;

      // Mise √† jour des styles des tabs
      folderTabs.forEach((t) => {
        if (t === tab) {
          t.className =
            "folder-tab px-3 py-1.5 text-xs rounded-full whitespace-nowrap bg-indigo-100 text-indigo-700 font-medium flex items-center gap-1";
        } else {
          t.className =
            "folder-tab px-3 py-1.5 text-xs rounded-full whitespace-nowrap bg-slate-100 text-slate-600 hover:bg-slate-200 flex items-center gap-1";
        }
      });

      // Filtrer les r√©f√©rences
      refItems.forEach((item) => {
        const itemFolder = (item as HTMLElement).dataset.folder;
        if (folderId === "all") {
          (item as HTMLElement).style.display = "";
        } else if (folderId === "none") {
          (item as HTMLElement).style.display =
            itemFolder === "none" ? "" : "none";
        } else {
          (item as HTMLElement).style.display =
            itemFolder === folderId ? "" : "none";
        }
      });
    });
  });

  useNewBtn.addEventListener("click", () => {
    useLibrary = false;
    useNewBtn.className =
      "flex-1 px-3 py-2 border-2 border-indigo-500 bg-indigo-50 text-indigo-700 rounded-lg text-sm font-medium";
    useLibraryBtn.className =
      "flex-1 px-3 py-2 border-2 border-slate-200 text-slate-600 rounded-lg text-sm font-medium hover:border-slate-300";
    librarySelection.classList.add("hidden");
    newReferenceUpload.classList.remove("hidden");
  });

  newRefDropZone.addEventListener("click", () => newReferenceInput.click());
  newReferenceInput.addEventListener("change", async (e) => {
    const file = (e.target as HTMLInputElement).files?.[0];
    if (file) {
      newReferenceFile = file;

      // Pour les formats Apple, convertir pour l'aper√ßu
      if (isAppleFormat(file)) {
        newRefPlaceholder.innerHTML =
          '<div class="text-2xl">üîÑ</div><p class="text-xs text-slate-500">Conversion...</p>';
        try {
          const formData = new FormData();
          formData.append("image", file);
          const response = await fetch("/api/convert-image", {
            method: "POST",
            body: formData,
          });
          if (!response.ok) throw new Error("√âchec");
          const blob = await response.blob();
          newRefPreviewImg.src = URL.createObjectURL(blob);
        } catch {
          newRefPreviewImg.src = "";
        }
      } else {
        newRefPreviewImg.src = URL.createObjectURL(file);
      }

      newRefPlaceholder.classList.add("hidden");
      newRefPreview.classList.remove("hidden");
    }
  });

  cancelInstructionBtn.addEventListener("click", () => {
    instructionModal.classList.add("hidden");
    instructionModal.classList.remove("flex");
  });

  confirmInstructionBtn.addEventListener("click", async () => {
    const location = instructionLocation.value.trim();
    if (!location) {
      alert("Veuillez entrer un emplacement");
      return;
    }

    if (useLibrary) {
      const selected = document.querySelector(
        'input[name="selectedReference"]:checked'
      ) as HTMLInputElement;
      if (!selected) {
        alert("Veuillez s√©lectionner une r√©f√©rence");
        return;
      }
      instructions.push({
        id: crypto.randomUUID(),
        location,
        referenceId: selected.value,
        referencePath: selected.dataset.path || "",
        referenceName: selected.dataset.name || undefined,
      });
    } else {
      if (!newReferenceFile) {
        alert("Veuillez s√©lectionner une image");
        return;
      }
      instructions.push({
        id: crypto.randomUUID(),
        location,
        referencePath: URL.createObjectURL(newReferenceFile),
        referenceName: newReferenceName.value.trim() || undefined,
        isNew: true,
        newFile: newReferenceFile,
      });
    }

    updateInstructionsList();
    instructionModal.classList.add("hidden");
    instructionModal.classList.remove("flex");
  });

  instructionModal.addEventListener("click", (e) => {
    if (e.target === instructionModal) {
      instructionModal.classList.add("hidden");
      instructionModal.classList.remove("flex");
    }
  });

  // √âtape 3 - G√©n√©ration
  let timerInterval: ReturnType<typeof setInterval> | null = null;
  let startTime = 0;

  function updateTimer() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const mins = Math.floor(elapsed / 60)
      .toString()
      .padStart(2, "0");
    const secs = (elapsed % 60).toString().padStart(2, "0");
    const timerEl = document.getElementById("logTimer");
    if (timerEl) timerEl.textContent = `${mins}:${secs}`;
  }

  function startTimer() {
    startTime = Date.now();
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(updateTimer, 1000);
    updateTimer();
  }

  function stopTimer() {
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
  }

  function updateGenerationStep(
    stepId: string,
    status: "pending" | "active" | "done" | "error"
  ) {
    const step = document.getElementById(stepId);
    if (!step) return;

    const iconContainer = step.querySelector(".step-icon") as HTMLElement;
    const iconSpan = iconContainer?.querySelector("span") as HTMLElement;
    const statusEl = step.querySelector(".step-status") as HTMLElement;

    step.classList.remove(
      "opacity-50",
      "border-green-300",
      "border-indigo-300",
      "border-red-300",
      "bg-green-50",
      "bg-indigo-50",
      "bg-red-50"
    );
    iconContainer?.classList.remove(
      "bg-green-100",
      "bg-indigo-100",
      "bg-red-100",
      "bg-slate-100"
    );

    switch (status) {
      case "pending":
        step.classList.add("opacity-50");
        iconContainer?.classList.add("bg-slate-100");
        if (iconSpan) iconSpan.textContent = "‚è≥";
        if (statusEl) statusEl.innerHTML = "";
        break;
      case "active":
        step.classList.add("bg-indigo-50", "border-indigo-300");
        iconContainer?.classList.add("bg-indigo-100");
        if (iconSpan)
          iconSpan.innerHTML = `<svg class="w-4 h-4 animate-spin text-indigo-600" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
        if (statusEl)
          statusEl.innerHTML = `<span class="text-xs text-indigo-600 font-medium">En cours...</span>`;
        break;
      case "done":
        step.classList.add("bg-green-50", "border-green-300");
        iconContainer?.classList.add("bg-green-100");
        if (iconSpan) iconSpan.textContent = "‚úì";
        if (statusEl)
          statusEl.innerHTML = `<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
        break;
      case "error":
        step.classList.add("bg-red-50", "border-red-300");
        iconContainer?.classList.add("bg-red-100");
        if (iconSpan) iconSpan.textContent = "‚úï";
        if (statusEl)
          statusEl.innerHTML = `<svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;
        break;
    }
  }

  function resetGenerationSteps() {
    ["step-upload", "step-analyze", "step-plan", "step-generate"].forEach(
      (id) => {
        updateGenerationStep(id, "pending");
      }
    );
    // Vider les logs et reset timer
    const logsContent = document.getElementById("logsContent");
    if (logsContent) logsContent.innerHTML = "";
    const timerEl = document.getElementById("logTimer");
    if (timerEl) timerEl.textContent = "00:00";
  }

  function createShareButtons(imageUrl: string) {
    const container = document.getElementById("shareButtonsContainer");
    if (!container) return;

    const fullImageUrl = imageUrl.startsWith("http")
      ? imageUrl
      : `${window.location.origin}${imageUrl}`;
    const pageUrl = window.location.href;
    const shareText =
      "D√©couvrez ma transformation Avant/Apr√®s r√©alis√©e avec l'IA !";

    container.innerHTML = `
      <!-- Copier le lien -->
      <button type="button" class="share-btn copy-link flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm font-medium transition-colors" title="Copier le lien">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
        </svg>
        <span class="copy-text">Copier</span>
      </button>

      <!-- Facebook -->
      <button type="button" class="share-btn facebook flex items-center gap-2 px-3 py-2 bg-[#1877F2] hover:bg-[#166FE5] text-white rounded-lg text-sm font-medium transition-colors" title="Partager sur Facebook">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
          <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
        </svg>
        <span class="hidden sm:inline">Facebook</span>
      </button>

      <!-- Twitter/X -->
      <button type="button" class="share-btn twitter flex items-center gap-2 px-3 py-2 bg-black hover:bg-gray-800 text-white rounded-lg text-sm font-medium transition-colors" title="Partager sur X">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
          <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
        </svg>
        <span class="hidden sm:inline">X</span>
      </button>

      <!-- WhatsApp -->
      <button type="button" class="share-btn whatsapp flex items-center gap-2 px-3 py-2 bg-[#25D366] hover:bg-[#20BD5A] text-white rounded-lg text-sm font-medium transition-colors" title="Partager sur WhatsApp">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
          <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
        </svg>
        <span class="hidden sm:inline">WhatsApp</span>
      </button>

      <!-- LinkedIn -->
      <button type="button" class="share-btn linkedin flex items-center gap-2 px-3 py-2 bg-[#0A66C2] hover:bg-[#004182] text-white rounded-lg text-sm font-medium transition-colors" title="Partager sur LinkedIn">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
          <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
        </svg>
        <span class="hidden sm:inline">LinkedIn</span>
      </button>

      <!-- T√©l√©charger -->
      <button type="button" class="share-btn download flex items-center gap-2 px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium transition-colors" title="T√©l√©charger">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
        </svg>
        <span class="hidden sm:inline">T√©l√©charger</span>
      </button>
    `;

    // Event listeners
    container
      .querySelector(".copy-link")
      ?.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(fullImageUrl);
          const copyText = container.querySelector(".copy-text");
          if (copyText) {
            copyText.textContent = "Copi√© !";
            setTimeout(() => {
              copyText.textContent = "Copier";
            }, 2000);
          }
        } catch (err) {
          console.error("Erreur copie:", err);
        }
      });

    container.querySelector(".facebook")?.addEventListener("click", () => {
      window.open(
        `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(pageUrl)}&quote=${encodeURIComponent(shareText)}`,
        "_blank",
        "width=600,height=400"
      );
    });

    container.querySelector(".twitter")?.addEventListener("click", () => {
      window.open(
        `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(pageUrl)}`,
        "_blank",
        "width=600,height=400"
      );
    });

    container.querySelector(".whatsapp")?.addEventListener("click", () => {
      window.open(
        `https://wa.me/?text=${encodeURIComponent(shareText + "\n" + pageUrl)}`,
        "_blank"
      );
    });

    container.querySelector(".linkedin")?.addEventListener("click", () => {
      window.open(
        `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(pageUrl)}`,
        "_blank",
        "width=600,height=400"
      );
    });

    container
      .querySelector(".download")
      ?.addEventListener("click", async () => {
        try {
          const response = await fetch(fullImageUrl);
          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `avant-apres-${Date.now()}.jpg`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } catch (err) {
          window.open(fullImageUrl, "_blank");
        }
      });
  }

  function addLog(icon: string, message: string, type?: string) {
    const logsContent = document.getElementById("logsContent");
    if (!logsContent) return;

    const timestamp = new Date().toLocaleTimeString("fr-FR", {
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
    });

    const logLine = document.createElement("div");
    logLine.className =
      "flex items-start gap-2 font-mono text-xs animate-fadeIn";

    let textColor = "text-slate-400";
    let bgColor = "";
    if (type === "success") {
      textColor = "text-emerald-400";
      bgColor = "bg-emerald-500/10 rounded px-1";
    }
    if (type === "error") {
      textColor = "text-red-400";
      bgColor = "bg-red-500/10 rounded px-1";
    }
    if (type === "header") {
      textColor = "text-cyan-400 font-semibold";
    }

    logLine.innerHTML = `
      <span class="text-slate-600 shrink-0">${timestamp}</span>
      <span class="shrink-0">${icon}</span>
      <span class="${textColor} ${bgColor} break-all">${message}</span>
    `;
    logsContent.appendChild(logLine);

    // Auto-scroll vers le bas
    logsContent.scrollTo({
      top: logsContent.scrollHeight,
      behavior: "smooth",
    });
  }

  toStep3Btn.addEventListener("click", async () => {
    goToStep(3);
    generatingState.classList.remove("hidden");
    resultState.classList.add("hidden");
    errorState.classList.add("hidden");
    resetGenerationSteps();
    startTimer();

    try {
      const formData = new FormData();
      formData.append("image", selectedImage!);
      formData.append(
        "instructions",
        JSON.stringify(
          instructions.map((i) => ({
            location: i.location,
            referenceId: i.referenceId,
            referenceName: i.referenceName,
            isNew: i.isNew,
          }))
        )
      );

      // Ajouter les nouvelles r√©f√©rences
      instructions.forEach((instr, idx) => {
        if (instr.isNew && instr.newFile) {
          formData.append(`newRef_${idx}`, instr.newFile);
        }
      });

      // Utiliser fetch avec streaming pour le SSE
      const response = await fetch("/api/generate-stream", {
        method: "POST",
        body: formData,
      });

      if (!response.ok) {
        throw new Error("Erreur de connexion au serveur");
      }

      const reader = response.body?.getReader();
      const decoder = new TextDecoder();
      let buffer = "";

      if (!reader) {
        throw new Error("Le streaming n'est pas support√©");
      }

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split("\n");
        buffer = lines.pop() || "";

        let currentEvent = "";
        for (const line of lines) {
          if (line.startsWith("event: ")) {
            currentEvent = line.substring(7);
          } else if (line.startsWith("data: ")) {
            try {
              const data = JSON.parse(line.substring(6));

              if (currentEvent === "log") {
                addLog(data.icon || "üìù", data.message, data.type);
              } else if (currentEvent === "step") {
                updateGenerationStep(`step-${data.step}`, data.status);
              } else if (currentEvent === "error") {
                if (data.noCredits) {
                  window.location.href = "/no-credits";
                  return;
                }
                throw new Error(data.message);
              } else if (currentEvent === "complete") {
                stopTimer();
                // Marquer toutes les √©tapes comme termin√©es
                [
                  "step-upload",
                  "step-analyze",
                  "step-plan",
                  "step-generate",
                ].forEach((id) => updateGenerationStep(id, "done"));

                // Nettoyer les chemins (enlever le / initial si pr√©sent)
                const cleanPath = (path: string) =>
                  path.startsWith("/") ? path.slice(1) : path;

                resultBeforeImg.src = `/api/images/${cleanPath(data.originalImage)}`;

                let generatedImageUrl = "";
                if (data.generatedImage) {
                  generatedImageUrl = `/api/images/${cleanPath(data.generatedImage)}`;
                  resultAfterImg.src = generatedImageUrl;
                  resultAfterImg.classList.remove("hidden");
                  resultDescription.classList.add("hidden");
                } else if (data.description) {
                  resultDescription.innerHTML = `<p class="whitespace-pre-wrap">${data.description}</p>`;
                  resultDescription.classList.remove("hidden");
                  resultAfterImg.classList.add("hidden");
                }

                // Cr√©er les boutons de partage
                createShareButtons(generatedImageUrl || resultBeforeImg.src);

                generatingState.classList.add("hidden");
                resultState.classList.remove("hidden");
              }
            } catch (e) {
              // Ignorer les erreurs de parsing JSON
            }
          }
        }
      }
    } catch (error: any) {
      console.error("Erreur:", error);
      stopTimer();
      addLog("‚ùå", error.message || "Erreur inconnue", "error");
      // Marquer l'√©tape en cours comme erreur
      ["step-upload", "step-analyze", "step-plan", "step-generate"].forEach(
        (id) => {
          const step = document.getElementById(id);
          if (step && !step.classList.contains("bg-green-50")) {
            updateGenerationStep(id, "error");
          }
        }
      );
      generatingState.classList.add("hidden");
      errorState.classList.remove("hidden");
      errorMessage.textContent = error.message || "Erreur inconnue";
    }
  });

  newGenerationBtn.addEventListener("click", () => {
    selectedImage = null;
    instructions = [];
    uploadPlaceholder.classList.remove("hidden");
    imagePreview.classList.add("hidden");
    toStep2Btn.disabled = true;
    updateInstructionsList();
    goToStep(1);
  });

  retryBtn.addEventListener("click", () => {
    goToStep(2);
  });
</script>
