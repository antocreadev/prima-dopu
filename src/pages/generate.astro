---
import Layout from "../layouts/Layout.astro";
import { SignedIn, SignedOut } from "@clerk/astro/components";
import ShareButtons from "../components/ShareButtons.astro";
import OnboardingTutorial from "../components/OnboardingTutorial.astro";
import ZoneMaskEditorWrapper from "../components/ZoneMaskEditorWrapper";
import {
  getUserReferences,
  getUserFolders,
  getCreditStats,
  canUserGenerate,
  isFirstTimeUser,
  type PlanType,
} from "../lib/db";
import { getUserPlan } from "../lib/plans";
import { getCreditsBalance } from "../lib/subscriptions";

const auth = Astro.locals.auth();
const userId = auth.userId;

if (!userId) {
  return Astro.redirect("/");
}

// D√©terminer le plan de l'utilisateur
const userPlanInfo = getUserPlan(userId);
const isAdmin = userPlanInfo.isAdmin === true;

// V√©rifier si c'est un nouvel utilisateur (pour le tutoriel)
const isFirstTime = isFirstTimeUser(userId);

// R√©cup√©rer les cr√©dits bonus (suppl√©mentaires achet√©s)
const bonusCredits = getCreditsBalance(userId);

// Passer les cr√©dits bonus aux fonctions
const creditStats = getCreditStats(
  userId,
  userPlanInfo.planType,
  isAdmin,
  bonusCredits
);
const creditCheck = canUserGenerate(
  userId,
  userPlanInfo.planType,
  isAdmin,
  bonusCredits
);

// Rediriger si plus de cr√©dits (sauf admin)
if (!isAdmin && !creditCheck.canGenerate) {
  return Astro.redirect("/no-credits");
}

const references = getUserReferences(userId);
const folders = getUserFolders(userId);

// Organiser les r√©f√©rences par dossier
const refsWithoutFolder = references.filter((r) => !r.folder_id);
const refsByFolder: Record<string, typeof references> = {};
folders.forEach((f) => {
  refsByFolder[f.id] = references.filter((r) => r.folder_id === f.id);
});
---

<Layout title="G√©n√©rer">
  <!-- Tutoriel d'onboarding pour les nouveaux utilisateurs -->
  <OnboardingTutorial isFirstTime={isFirstTime} />

  <SignedOut>
    <div class="text-center py-20">
      <p class="text-slate-600">
        Veuillez vous connecter pour acc√©der √† cette page.
      </p>
    </div>
  </SignedOut>
  <SignedIn>
    <div class="max-w-4xl mx-auto">
      <!-- En-t√™te avec cr√©dits -->
      <div
        class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8"
      >
        <div>
          <h1 class="text-3xl font-bold mb-2">Nouvelle g√©n√©ration</h1>
          <p class="text-slate-600">
            Cr√©ez votre visualisation avant/apr√®s en quelques √©tapes
          </p>
        </div>

        <!-- Badge des cr√©dits -->
        {
          isAdmin ? (
            <div class="flex items-center gap-3 px-4 py-3 rounded-xl border bg-gradient-to-r from-purple-50 to-indigo-50 border-purple-200">
              <div class="text-center">
                <div class="text-2xl font-bold text-purple-600">‚àû</div>
                <div class="text-xs text-purple-500">illimit√©</div>
              </div>
              <div class="w-px h-8 bg-purple-200" />
              <div class="text-sm">
                <div class="font-medium text-purple-800">üëë Admin</div>
                <span class="text-purple-600 text-xs">
                  G√©n√©rations illimit√©es
                </span>
              </div>
            </div>
          ) : (
            <div
              class:list={[
                "flex items-center gap-3 px-4 py-3 rounded-xl border",
                creditStats.remaining <= 2
                  ? "bg-orange-50 border-orange-200"
                  : "bg-slate-50 border-slate-200",
              ]}
            >
              <div class="text-center">
                <div
                  class:list={[
                    "text-2xl font-bold",
                    creditStats.remaining === 0
                      ? "text-red-600"
                      : creditStats.remaining <= 2
                        ? "text-orange-600"
                        : "text-slate-900",
                  ]}
                >
                  {creditStats.remaining}
                </div>
                <div class="text-xs text-slate-500">
                  restant{creditStats.remaining > 1 ? "s" : ""}
                </div>
              </div>
              <div class="w-px h-8 bg-slate-300" />
              <div class="text-sm">
                <div class="font-medium text-slate-800">
                  Plan {creditStats.planName}
                </div>
                <a
                  href="/pricing"
                  class="text-orange-600 hover:underline text-xs"
                >
                  {userPlanInfo.isPaid ? "G√©rer" : "Upgrader"}
                </a>
              </div>
            </div>
          )
        }
      </div>

      <!-- Indicateur d'√©tapes -->
      <div class="flex items-center justify-center mb-8">
        <div class="flex items-center">
          <div
            id="step1Indicator"
            class="w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold"
          >
            1
          </div>
          <div class="w-24 h-1 bg-slate-200" id="step1Line"></div>
          <div
            id="step2Indicator"
            class="w-10 h-10 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center font-bold"
          >
            2
          </div>
          <div class="w-24 h-1 bg-slate-200" id="step2Line"></div>
          <div
            id="step3Indicator"
            class="w-10 h-10 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center font-bold"
          >
            3
          </div>
        </div>
      </div>

      <!-- √âtape 1: Upload photo -->
      <div id="step1" class="bg-white rounded-xl border border-slate-200 p-6">
        <h2 class="text-xl font-semibold mb-4">
          üì∏ √âtape 1 : T√©l√©chargez votre photo
        </h2>
        <p class="text-slate-600 mb-4">
          S√©lectionnez une photo de l'espace que vous souhaitez transformer
        </p>

        <!-- Conseil photo horizontale -->
        <div
          class="mb-6 p-4 bg-amber-50 border border-amber-200 rounded-xl flex items-center gap-4"
        >
          <div class="phone-rotate-animation flex-shrink-0">
            <div class="phone-icon">
              <svg
                width="40"
                height="60"
                viewBox="0 0 40 60"
                class="text-amber-600"
              >
                <rect
                  x="4"
                  y="4"
                  width="32"
                  height="52"
                  rx="4"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"></rect>
                <circle cx="20" cy="50" r="3" fill="currentColor"></circle>
                <rect
                  x="14"
                  y="8"
                  width="12"
                  height="2"
                  rx="1"
                  fill="currentColor"></rect>
              </svg>
            </div>
          </div>
          <div>
            <p class="font-medium text-amber-800">
              üì± Conseil : Prenez la photo en mode paysage
            </p>
            <p class="text-sm text-amber-700 mt-1">
              Tournez votre t√©l√©phone √† l'horizontale pour de meilleurs
              r√©sultats
            </p>
          </div>
        </div>

        <style>
          .phone-rotate-animation {
            animation: rotatePhone 2s ease-in-out infinite;
          }
          @keyframes rotatePhone {
            0%,
            100% {
              transform: rotate(0deg);
            }
            30%,
            70% {
              transform: rotate(-90deg);
            }
          }
          .phone-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
          }
        </style>

        <div
          id="uploadZone"
          class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:border-indigo-400 transition-colors"
        >
          <input type="file" id="imageInput" accept="image/*" class="hidden" />
          <div id="uploadPlaceholder">
            <div class="text-5xl mb-4">üì∑</div>
            <p class="text-slate-600 mb-2">Glissez-d√©posez une image ici</p>
            <p class="text-slate-400 text-sm mb-4">ou</p>
            <button
              type="button"
              id="selectImageBtn"
              class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
            >
              S√©lectionner une image
            </button>
          </div>
          <div id="imagePreview" class="hidden">
            <img
              id="previewImg"
              src=""
              alt="Aper√ßu"
              class="max-h-64 mx-auto rounded-lg"
            />
            <button
              type="button"
              id="changeImageBtn"
              class="mt-4 px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors"
            >
              Changer l'image
            </button>
          </div>
        </div>

        <div class="mt-6 flex justify-end">
          <button
            type="button"
            id="toStep2Btn"
            class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            Continuer ‚Üí
          </button>
        </div>
      </div>

      <!-- √âtape 2: Instructions -->
      <div
        id="step2"
        class="bg-white rounded-xl border border-slate-200 p-6 hidden"
      >
        <h2 class="text-xl font-semibold mb-4">
          üé® √âtape 2 : Ajoutez vos instructions
        </h2>
        <p class="text-slate-600 mb-6">
          D√©finissez les modifications √† appliquer √† chaque zone
        </p>

        <div class="grid md:grid-cols-2 gap-6 mb-6">
          <!-- Aper√ßu image -->
          <div>
            <h3 class="font-medium text-slate-700 mb-2">Votre image</h3>
            <img
              id="step2PreviewImg"
              src=""
              alt="Image originale"
              class="w-full rounded-lg border border-slate-200"
            />
          </div>

          <!-- Liste des instructions -->
          <div>
            <div class="flex justify-between items-center mb-2">
              <h3 class="font-medium text-slate-700">Instructions</h3>
              <button
                type="button"
                id="addInstructionBtn"
                class="text-indigo-600 hover:text-indigo-700 text-sm font-medium"
              >
                + Ajouter une instruction
              </button>
            </div>

            <div
              id="instructionsList"
              class="space-y-3 max-h-80 overflow-y-auto"
            >
              <!-- Les instructions seront ajout√©es ici dynamiquement -->
            </div>

            <div id="noInstructions" class="text-center py-8 text-slate-400">
              Aucune instruction. Cliquez sur "Ajouter une instruction" pour
              commencer.
            </div>
          </div>
        </div>

        <div class="mt-6 flex justify-between">
          <button
            type="button"
            id="backToStep1Btn"
            class="px-6 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors"
          >
            ‚Üê Retour
          </button>
          <button
            type="button"
            id="toStep3Btn"
            class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            G√©n√©rer ‚Üí
          </button>
        </div>
      </div>

      <!-- √âtape 3: R√©sultat -->
      <div
        id="step3"
        class="bg-white rounded-xl border border-slate-200 p-6 hidden"
      >
        <h2 class="text-xl font-semibold mb-4">‚ú® √âtape 3 : R√©sultat</h2>

        <div id="generatingState" class="text-center py-12">
          <!-- Loader anim√© -->
          <div class="relative w-24 h-24 mx-auto mb-6">
            <div
              class="absolute inset-0 rounded-full border-4 border-slate-200"
            >
            </div>
            <div
              class="absolute inset-0 rounded-full border-4 border-indigo-600 border-t-transparent animate-spin"
            >
            </div>
            <div
              class="absolute inset-3 rounded-full border-4 border-purple-400 border-b-transparent animate-spin"
              style="animation-direction: reverse; animation-duration: 1.5s;"
            >
            </div>
            <div
              class="absolute inset-0 flex items-center justify-center text-3xl"
            >
              üé®
            </div>
          </div>

          <p class="text-lg font-medium text-slate-800 mb-2">
            G√©n√©ration en cours...
          </p>

          <!-- √âtapes de progression -->
          <div
            id="generationSteps"
            class="max-w-lg mx-auto mt-6 text-left space-y-1"
          >
            <div
              id="step-upload"
              class="flex items-center gap-3 p-3 rounded-xl bg-white border border-slate-200 shadow-sm transition-all duration-300"
            >
              <div
                class="step-icon w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center"
              >
                <span class="text-sm">‚è≥</span>
              </div>
              <div class="flex-1">
                <span class="text-sm font-medium text-slate-700"
                  >Envoi des images</span
                >
                <p class="text-xs text-slate-400">
                  T√©l√©chargement vers le cloud
                </p>
              </div>
              <div class="step-status"></div>
            </div>
            <div
              id="step-analyze"
              class="flex items-center gap-3 p-3 rounded-xl bg-white border border-slate-200 shadow-sm opacity-50 transition-all duration-300"
            >
              <div
                class="step-icon w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center"
              >
                <span class="text-sm">‚è≥</span>
              </div>
              <div class="flex-1">
                <span class="text-sm font-medium text-slate-700"
                  >Analyse IA</span
                >
                <p class="text-xs text-slate-400">Compr√©hension de l'espace</p>
              </div>
              <div class="step-status"></div>
            </div>
            <div
              id="step-plan"
              class="flex items-center gap-3 p-3 rounded-xl bg-white border border-slate-200 shadow-sm opacity-50 transition-all duration-300"
            >
              <div
                class="step-icon w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center"
              >
                <span class="text-sm">‚è≥</span>
              </div>
              <div class="flex-1">
                <span class="text-sm font-medium text-slate-700"
                  >Planification</span
                >
                <p class="text-xs text-slate-400">Mapping des modifications</p>
              </div>
              <div class="step-status"></div>
            </div>
            <div
              id="step-generate"
              class="flex items-center gap-3 p-3 rounded-xl bg-white border border-slate-200 shadow-sm opacity-50 transition-all duration-300"
            >
              <div
                class="step-icon w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center"
              >
                <span class="text-sm">‚è≥</span>
              </div>
              <div class="flex-1">
                <span class="text-sm font-medium text-slate-700"
                  >G√©n√©ration</span
                >
                <p class="text-xs text-slate-400">Cr√©ation de l'image finale</p>
              </div>
              <div class="step-status"></div>
            </div>
          </div>

          <p class="text-xs text-slate-400 mt-6">
            Cela peut prendre jusqu'√† 3 minutes
          </p>
        </div>

        <div id="resultState" class="hidden">
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <h3 class="font-medium text-slate-700 mb-2">Avant</h3>
              <img
                id="resultBeforeImg"
                src=""
                alt="Avant"
                class="w-full rounded-lg border border-slate-200 cursor-pointer hover:opacity-90 transition-opacity lightbox-trigger"
              />
            </div>
            <div>
              <h3 class="font-medium text-slate-700 mb-2">
                Apr√®s (g√©n√©r√© par IA)
              </h3>
              <img
                id="resultAfterImg"
                src=""
                alt="Apr√®s"
                class="w-full rounded-lg border border-slate-200 hidden cursor-pointer hover:opacity-90 transition-opacity lightbox-trigger"
              />
              <div
                id="resultDescription"
                class="prose prose-sm max-w-none p-4 bg-slate-50 rounded-lg border border-slate-200 max-h-80 overflow-y-auto hidden"
              >
              </div>
            </div>
          </div>

          <!-- Boutons de partage -->
          <div id="shareButtonsWrapper" class="mt-6 pb-5">
            <ShareButtons
              imageUrl=""
              title="Ma transformation Avant/Apr√®s"
              description="D√©couvrez cette transformation r√©alis√©e avec PrimaDopu !"
            />
          </div>

          <!-- Section masques combin√©s (debug) -->
          <!-- <div id="combinedMasksSection" class="hidden mt-4 mb-6">
            <button
              type="button"
              id="toggleCombinedMasksBtn"
              class="flex items-center gap-2 text-sm text-slate-500 hover:text-indigo-600 transition-colors"
            >
              <span>üé≠</span>
              <span>Voir les masques combin√©s</span>
              <svg id="combinedMasksChevron" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div id="combinedMasksContainer" class="hidden mt-3 grid gap-4 md:grid-cols-2 lg:grid-cols-3">
            </div>
          </div> -->

          <div class="flex justify-between gap-2">
            <a
              href="/history"
              class="px-6 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors"
            >
              Voir l'historique
            </a>
            <button
              type="button"
              id="newGenerationBtn"
              class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors"
            >
              Nouvelle g√©n√©ration
            </button>
          </div>
        </div>

        <div id="errorState" class="hidden text-center py-12">
          <div class="text-5xl mb-4">‚ùå</div>
          <p class="text-lg text-red-600">Une erreur est survenue</p>
          <p id="errorMessage" class="text-sm text-slate-400 mt-2"></p>
          <button
            type="button"
            id="retryBtn"
            class="mt-4 px-6 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors"
          >
            R√©essayer
          </button>
        </div>
      </div>

      <!-- Modal d'ajout d'instruction -->
      <div
        id="instructionModal"
        class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50"
      >
        <div
          class="bg-white rounded-xl p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto"
        >
          <h2 class="text-xl font-semibold mb-4">Ajouter une instruction</h2>

          <div class="mb-4">
            <label
              class="flex items-center gap-1.5 text-sm font-medium text-slate-700 mb-2"
            >
              Zone √† modifier *
              <button
                type="button"
                id="toggleTipsBtn"
                class="text-slate-400 hover:text-indigo-600 transition-colors"
                title="Voir les conseils"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>
              </button>
            </label>
            <div class="flex gap-2">
              <input
                type="text"
                id="instructionLocation"
                placeholder="Ex: tout le sol, mur de droite, tous les murs..."
                class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
              />
              <button
                type="button"
                id="openMaskEditorBtn"
                class="px-3 py-2 border border-slate-300 text-slate-600 rounded-lg hover:bg-slate-50 hover:border-indigo-400 hover:text-indigo-600 transition-colors text-sm whitespace-nowrap flex items-center gap-1.5"
                title="D√©limiter la zone avec pr√©cision (optionnel)"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                </svg>
                <span class="hidden sm:inline">D√©limiter</span>
              </button>
            </div>
            <p class="mt-1.5 text-xs text-slate-400">
              üí° La d√©limitation est optionnelle mais am√©liore la pr√©cision
            </p>
            <div
              id="maskIndicator"
              class="mt-2 text-xs text-green-600 items-center gap-1 hidden"
            >
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                  clip-rule="evenodd"></path>
              </svg>
              Zone d√©limit√©e avec pr√©cision
            </div>

            <!-- Suggestions rapides -->
            <div class="mt-2 flex gap-1.5 overflow-x-auto pb-2 scrollbar-hide">
              <style>
                .zone-suggestions-container::-webkit-scrollbar {
                  height: 6px;
                }
                .zone-suggestions-container::-webkit-scrollbar-track {
                  background: #f1f5f9;
                  border-radius: 3px;
                }
                .zone-suggestions-container::-webkit-scrollbar-thumb {
                  background: #cbd5e1;
                  border-radius: 3px;
                }
                .zone-suggestions-container::-webkit-scrollbar-thumb:hover {
                  background: #94a3b8;
                }
              </style>
              <button
                type="button"
                class="zone-suggestion px-2 py-1 text-xs bg-slate-100 hover:bg-slate-200 rounded-full text-slate-600 whitespace-nowrap flex-shrink-0"
                data-zone="tout le sol"
              >
                üü´ Sol complet
              </button>
              <button
                type="button"
                class="zone-suggestion px-2 py-1 text-xs bg-slate-100 hover:bg-slate-200 rounded-full text-slate-600 whitespace-nowrap flex-shrink-0"
                data-zone="mur de gauche"
              >
                ‚¨ÖÔ∏è Mur gauche
              </button>
              <button
                type="button"
                class="zone-suggestion px-2 py-1 text-xs bg-slate-100 hover:bg-slate-200 rounded-full text-slate-600 whitespace-nowrap flex-shrink-0"
                data-zone="mur de droite"
              >
                ‚û°Ô∏è Mur droite
              </button>
              <button
                type="button"
                class="zone-suggestion px-2 py-1 text-xs bg-slate-100 hover:bg-slate-200 rounded-full text-slate-600 whitespace-nowrap flex-shrink-0"
                data-zone="mur du fond"
              >
                ‚¨ÜÔ∏è Mur fond
              </button>
              <button
                type="button"
                class="zone-suggestion px-2 py-1 text-xs bg-slate-100 hover:bg-slate-200 rounded-full text-slate-600 whitespace-nowrap flex-shrink-0"
                data-zone="plafond"
              >
                üîù Plafond
              </button>
            </div>

            <!-- Conseils (cach√©s par d√©faut) - Affichage en notification -->
            <div
              id="tipsSection"
              class="fixed top-4 right-4 z-50 hidden max-w-sm animate-fadeIn"
            >
              <div
                class="bg-white border-l-4 border-amber-400 shadow-xl rounded-lg p-4"
              >
                <div class="flex items-start gap-3">
                  <div class="flex-shrink-0">
                    <svg
                      class="w-5 h-5 text-amber-500"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                        clip-rule="evenodd"></path>
                    </svg>
                  </div>
                  <div class="flex-1">
                    <p class="font-medium mb-2 text-amber-800 text-sm">
                      üí° Conseils pour de meilleurs r√©sultats
                    </p>
                    <ul
                      class="list-disc list-inside space-y-1 text-xs text-slate-600"
                    >
                      <li>
                        <strong>Soyez pr√©cis</strong> : "mur de droite" plut√¥t que
                        "mur"
                      </li>
                      <li>
                        <strong>Une zone par instruction</strong> : cr√©ez une instruction
                        par zone
                      </li>
                      <li>
                        <strong>Pour le sol</strong> : pr√©cisez "pose horizontale"
                        ou "pose verticale" si souhait√©
                      </li>
                    </ul>
                  </div>
                  <button
                    type="button"
                    id="closeTipsBtn"
                    class="flex-shrink-0 text-slate-400 hover:text-slate-600 transition-colors"
                  >
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-medium text-slate-700 mb-2">
              R√©f√©rence *
            </label>

            <div class="mb-3">
              <div class="flex gap-2 mb-2">
                <button
                  type="button"
                  id="useLibraryBtn"
                  class="flex-1 px-3 py-2 border-2 border-indigo-500 bg-indigo-50 text-indigo-700 rounded-lg text-sm font-medium"
                >
                  üìö Biblioth√®que
                </button>
                <button
                  type="button"
                  id="useNewBtn"
                  class="flex-1 px-3 py-2 border-2 border-slate-200 text-slate-600 rounded-lg text-sm font-medium hover:border-slate-300"
                >
                  üì∑ Nouvelle
                </button>
              </div>
            </div>

            <!-- S√©lection depuis la biblioth√®que -->
            <div id="librarySelection">
              {
                references.length > 0 ? (
                  <div>
                    {/* Tabs des dossiers */}
                    <div class="flex gap-1 mb-3 overflow-x-auto pb-2 scrollbar-hide">
                      <button
                        type="button"
                        class="folder-tab px-3 py-1.5 text-xs rounded-full whitespace-nowrap bg-indigo-100 text-indigo-700 font-medium"
                        data-folder="all"
                      >
                        üìö Tout ({references.length})
                      </button>
                      {refsWithoutFolder.length > 0 && (
                        <button
                          type="button"
                          class="folder-tab px-3 py-1.5 text-xs rounded-full whitespace-nowrap bg-slate-100 text-slate-600 hover:bg-slate-200"
                          data-folder="none"
                        >
                          üìÑ Sans dossier ({refsWithoutFolder.length})
                        </button>
                      )}
                      {folders.map(
                        (folder) =>
                          refsByFolder[folder.id]?.length > 0 && (
                            <button
                              type="button"
                              class="folder-tab px-3 py-1.5 text-xs rounded-full whitespace-nowrap bg-slate-100 text-slate-600 hover:bg-slate-200 flex items-center gap-1"
                              data-folder={folder.id}
                            >
                              <span
                                class="w-2 h-2 rounded-sm"
                                style={`background-color: ${folder.color}`}
                              />
                              {folder.name} (
                              {refsByFolder[folder.id]?.length || 0})
                            </button>
                          )
                      )}
                    </div>

                    {/* Grille toutes les r√©f√©rences */}
                    <div
                      id="refs-all"
                      class="refs-grid grid grid-cols-3 gap-2 max-h-48 overflow-y-auto p-1"
                    >
                      {references.map((ref) => (
                        <label
                          class="cursor-pointer ref-item"
                          data-folder={ref.folder_id || "none"}
                        >
                          <input
                            type="radio"
                            name="selectedReference"
                            value={ref.id}
                            data-path={ref.image_path}
                            data-name={ref.name || ""}
                            class="hidden peer"
                          />
                          <div class="peer-checked:ring-2 peer-checked:ring-indigo-500 rounded-lg overflow-hidden border border-slate-200">
                            <img
                              src={`/api/images/${ref.image_path.replace("/uploads/", "").replace("/uploads", "").replace(/^\//, "")}`}
                              alt={ref.name || "R√©f√©rence"}
                              class="w-full aspect-square object-cover"
                            />
                            <p class="p-1 text-xs truncate text-center">
                              {ref.name || "Sans nom"}
                            </p>
                          </div>
                        </label>
                      ))}
                    </div>
                  </div>
                ) : (
                  <div class="text-center py-4 text-slate-400 text-sm">
                    Aucune r√©f√©rence dans votre biblioth√®que.
                    <a
                      href="/library"
                      class="text-indigo-600 hover:underline block mt-1"
                    >
                      Ajouter des r√©f√©rences
                    </a>
                  </div>
                )
              }
            </div>

            <!-- Upload nouvelle r√©f√©rence -->
            <div id="newReferenceUpload" class="hidden">
              <input
                type="file"
                id="newReferenceInput"
                accept="image/*"
                class="hidden"
              />
              <div
                id="newRefDropZone"
                class="border-2 border-dashed border-slate-300 rounded-lg p-4 text-center cursor-pointer hover:border-indigo-400 transition-colors"
              >
                <div id="newRefPlaceholder">
                  <p class="text-slate-600 text-sm">
                    Cliquez ou glissez une image
                  </p>
                </div>
                <div id="newRefPreview" class="hidden">
                  <img
                    id="newRefPreviewImg"
                    src=""
                    alt="Aper√ßu"
                    class="max-h-24 mx-auto rounded"
                  />
                </div>
              </div>
              <div class="mt-2">
                <label class="block text-xs text-slate-500 mb-1"
                  >Nom et description</label
                >
                <input
                  type="text"
                  id="newReferenceName"
                  placeholder="Ex: Parquet ch√™ne clair, Carrelage m√©tro blanc, Peinture gris anthracite..."
                  class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                />
              </div>
            </div>
          </div>

          <div class="flex gap-3">
            <button
              type="button"
              id="cancelInstructionBtn"
              class="flex-1 px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors"
            >
              Annuler
            </button>
            <button
              type="button"
              id="confirmInstructionBtn"
              class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
            >
              Ajouter
            </button>
          </div>
        </div>
      </div>

      <!-- Lightbox pour voir les images en grand -->
      <div
        id="lightboxModal"
        class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[100] cursor-zoom-out"
      >
        <button
          type="button"
          id="lightboxClose"
          class="absolute top-4 right-4 p-2 text-white/80 hover:text-white transition-colors z-10"
          aria-label="Fermer"
        >
          <svg
            class="w-8 h-8"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
        <img
          id="lightboxImg"
          src=""
          alt="Image en grand"
          class="max-w-[95vw] max-h-[95vh] object-contain rounded-lg shadow-2xl cursor-default"
        />
      </div>

      <!-- Zone Mask Editor -->
      <ZoneMaskEditorWrapper client:only="react" />
    </div>
  </SignedIn>
</Layout>

<script>
  // Type pour l'API Wake Lock
  interface WakeLockSentinel {
    readonly released: boolean;
    readonly type: 'screen';
    release(): Promise<void>;
  }

  interface Instruction {
    id: string;
    location: string;
    referenceId?: string;
    referencePath: string;
    referenceName?: string;
    isNew?: boolean;
    newFile?: File;
    maskDataUrl?: string;
  }

  let currentStep = 1;
  let selectedImage: File | null = null;
  let instructions: Instruction[] = [];
  let useLibrary = true;
  let newReferenceFile: File | null = null;
  let showMaskEditor = false;
  let currentMaskDataUrl: string | null = null;

  // √âl√©ments DOM
  const step1 = document.getElementById("step1")!;
  const step2 = document.getElementById("step2")!;
  const step3 = document.getElementById("step3")!;
  const imageInput = document.getElementById("imageInput") as HTMLInputElement;
  const selectImageBtn = document.getElementById("selectImageBtn")!;
  const uploadZone = document.getElementById("uploadZone")!;
  const uploadPlaceholder = document.getElementById("uploadPlaceholder")!;
  const imagePreview = document.getElementById("imagePreview")!;
  const previewImg = document.getElementById("previewImg") as HTMLImageElement;
  const changeImageBtn = document.getElementById("changeImageBtn")!;
  const toStep2Btn = document.getElementById("toStep2Btn") as HTMLButtonElement;
  const step2PreviewImg = document.getElementById(
    "step2PreviewImg"
  ) as HTMLImageElement;
  const backToStep1Btn = document.getElementById("backToStep1Btn")!;
  const toStep3Btn = document.getElementById("toStep3Btn") as HTMLButtonElement;
  const addInstructionBtn = document.getElementById("addInstructionBtn")!;
  const instructionsList = document.getElementById("instructionsList")!;
  const noInstructions = document.getElementById("noInstructions")!;
  const instructionModal = document.getElementById("instructionModal")!;
  const instructionLocation = document.getElementById(
    "instructionLocation"
  ) as HTMLInputElement;
  const useLibraryBtn = document.getElementById("useLibraryBtn")!;
  const useNewBtn = document.getElementById("useNewBtn")!;
  const librarySelection = document.getElementById("librarySelection")!;
  const newReferenceUpload = document.getElementById("newReferenceUpload")!;
  const newReferenceInput = document.getElementById(
    "newReferenceInput"
  ) as HTMLInputElement;
  const newRefDropZone = document.getElementById("newRefDropZone")!;
  const newRefPlaceholder = document.getElementById("newRefPlaceholder")!;
  const newRefPreview = document.getElementById("newRefPreview")!;
  const newRefPreviewImg = document.getElementById(
    "newRefPreviewImg"
  ) as HTMLImageElement;
  const newReferenceName = document.getElementById(
    "newReferenceName"
  ) as HTMLInputElement;
  const cancelInstructionBtn = document.getElementById("cancelInstructionBtn")!;
  const confirmInstructionBtn = document.getElementById(
    "confirmInstructionBtn"
  )!;
  const generatingState = document.getElementById("generatingState")!;
  const resultState = document.getElementById("resultState")!;
  const errorState = document.getElementById("errorState")!;
  const resultBeforeImg = document.getElementById(
    "resultBeforeImg"
  ) as HTMLImageElement;
  const resultAfterImg = document.getElementById(
    "resultAfterImg"
  ) as HTMLImageElement;
  const resultDescription = document.getElementById("resultDescription")!;
  const errorMessage = document.getElementById("errorMessage")!;
  const newGenerationBtn = document.getElementById("newGenerationBtn")!;
  const retryBtn = document.getElementById("retryBtn")!;
  const openMaskEditorBtn = document.getElementById("openMaskEditorBtn")!;
  const maskIndicator = document.getElementById("maskIndicator")!;

  // Indicateurs
  const step1Indicator = document.getElementById("step1Indicator")!;
  const step2Indicator = document.getElementById("step2Indicator")!;
  const step3Indicator = document.getElementById("step3Indicator")!;
  const step1Line = document.getElementById("step1Line")!;
  const step2Line = document.getElementById("step2Line")!;

  function updateStepIndicators() {
    step1Indicator.className =
      currentStep >= 1
        ? "w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold"
        : "w-10 h-10 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center font-bold";
    step2Indicator.className =
      currentStep >= 2
        ? "w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold"
        : "w-10 h-10 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center font-bold";
    step3Indicator.className =
      currentStep >= 3
        ? "w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold"
        : "w-10 h-10 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center font-bold";
    step1Line.className =
      currentStep >= 2 ? "w-24 h-1 bg-indigo-600" : "w-24 h-1 bg-slate-200";
    step2Line.className =
      currentStep >= 3 ? "w-24 h-1 bg-indigo-600" : "w-24 h-1 bg-slate-200";
  }

  function goToStep(step: number) {
    currentStep = step;
    step1.classList.toggle("hidden", step !== 1);
    step2.classList.toggle("hidden", step !== 2);
    step3.classList.toggle("hidden", step !== 3);
    updateStepIndicators();
  }

  // √âtape 1 - Upload image
  selectImageBtn.addEventListener("click", () => imageInput.click());
  changeImageBtn.addEventListener("click", () => imageInput.click());

  imageInput.addEventListener("change", (e) => {
    const file = (e.target as HTMLInputElement).files?.[0];
    if (file) handleImageSelect(file);
  });

  uploadZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    uploadZone.classList.add("border-indigo-400", "bg-indigo-50");
  });

  uploadZone.addEventListener("dragleave", () => {
    uploadZone.classList.remove("border-indigo-400", "bg-indigo-50");
  });

  uploadZone.addEventListener("drop", (e) => {
    e.preventDefault();
    uploadZone.classList.remove("border-indigo-400", "bg-indigo-50");
    const file = e.dataTransfer?.files?.[0];
    if (file && isImageFile(file)) handleImageSelect(file);
  });

  // Fonction helper pour convertir les chemins d'images vers l'API
  function getImageUrl(path: string): string {
    if (!path) return "";
    if (path.startsWith("blob:") || path.startsWith("data:")) {
      return path; // URL blob ou data URL - pas de conversion
    }
    // Nettoyer le chemin
    let cleanPath = path.replace("/uploads/", "/").replace("/uploads", "");
    // Retirer le / initial pour √©viter le double slash
    if (cleanPath.startsWith("/")) cleanPath = cleanPath.slice(1);
    return `/api/images/${cleanPath}`;
  }

  // V√©rifie si c'est un fichier image (inclut HEIC/HEIF)
  function isImageFile(file: File): boolean {
    const ext = file.name.toLowerCase().split(".").pop() || "";
    const imageExts = [
      "jpg",
      "jpeg",
      "png",
      "gif",
      "webp",
      "heic",
      "heif",
      "hif",
      "bmp",
      "tiff",
    ];
    return file.type.startsWith("image/") || imageExts.includes(ext);
  }

  // V√©rifie si c'est un format Apple n√©cessitant conversion
  function isAppleFormat(file: File): boolean {
    const ext = file.name.toLowerCase().split(".").pop() || "";
    return ["heic", "heif", "hif"].includes(ext);
  }

  async function handleImageSelect(file: File) {
    selectedImage = file;

    // Pour les formats Apple (HEIC/HEIF), convertir via l'API pour l'aper√ßu
    if (isAppleFormat(file)) {
      uploadPlaceholder.innerHTML =
        '<div class="text-5xl mb-4">üîÑ</div><p class="text-slate-600">Conversion en cours...</p>';

      try {
        const formData = new FormData();
        formData.append("image", file);

        const response = await fetch("/api/convert-image", {
          method: "POST",
          body: formData,
        });

        if (!response.ok) throw new Error("√âchec de la conversion");

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        previewImg.src = url;
        step2PreviewImg.src = url;
      } catch (error) {
        console.error("Erreur conversion aper√ßu:", error);
        // Fallback: afficher un placeholder
        previewImg.src = "";
        previewImg.alt =
          "Format HEIC - Aper√ßu non disponible (la g√©n√©ration fonctionnera)";
      }
    } else {
      const url = URL.createObjectURL(file);
      previewImg.src = url;
      step2PreviewImg.src = url;
    }

    uploadPlaceholder.innerHTML = `
      <div class="text-5xl mb-4">üì∑</div>
      <p class="text-slate-600 mb-2">Glissez-d√©posez une image ici</p>
      <p class="text-slate-400 text-sm mb-4">ou</p>
      <button
        type="button"
        id="selectImageBtn"
        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
      >
        S√©lectionner une image
      </button>
    `;
    uploadPlaceholder.classList.add("hidden");
    imagePreview.classList.remove("hidden");
    toStep2Btn.disabled = false;
  }

  toStep2Btn.addEventListener("click", () => goToStep(2));
  backToStep1Btn.addEventListener("click", () => goToStep(1));

  // √âtape 2 - Instructions
  function updateInstructionsList() {
    if (instructions.length === 0) {
      noInstructions.classList.remove("hidden");
      instructionsList.innerHTML = "";
      toStep3Btn.disabled = true;
    } else {
      noInstructions.classList.add("hidden");
      toStep3Btn.disabled = false;
      instructionsList.innerHTML = instructions
        .map(
          (instr, idx) => `
        <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg">
          <img src="${getImageUrl(instr.referencePath)}" alt="R√©f√©rence" class="w-12 h-12 rounded object-cover" />
          <div class="flex-1 min-w-0">
            <p class="font-medium text-slate-800 truncate">${instr.location}</p>
            <p class="text-sm text-slate-500 truncate">${instr.referenceName || "Sans nom"}</p>
          </div>
          <button type="button" class="delete-instruction p-2 text-red-500 hover:bg-red-50 rounded-lg" data-idx="${idx}">
            üóëÔ∏è
          </button>
        </div>
      `
        )
        .join("");

      document.querySelectorAll(".delete-instruction").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const idx = parseInt(
            (e.currentTarget as HTMLElement).dataset.idx || "0"
          );
          instructions.splice(idx, 1);
          updateInstructionsList();
        });
      });
    }
  }

  addInstructionBtn.addEventListener("click", () => {
    instructionLocation.value = "";
    newReferenceName.value = "";
    newReferenceFile = null;
    currentMaskDataUrl = null;
    maskIndicator.classList.add("hidden");
    newRefPlaceholder.classList.remove("hidden");
    newRefPreview.classList.add("hidden");
    document
      .querySelectorAll('input[name="selectedReference"]')
      .forEach((el) => {
        (el as HTMLInputElement).checked = false;
      });
    useLibrary = true;
    useLibraryBtn.className =
      "flex-1 px-3 py-2 border-2 border-indigo-500 bg-indigo-50 text-indigo-700 rounded-lg text-sm font-medium";
    useNewBtn.className =
      "flex-1 px-3 py-2 border-2 border-slate-200 text-slate-600 rounded-lg text-sm font-medium hover:border-slate-300";
    librarySelection.classList.remove("hidden");
    newReferenceUpload.classList.add("hidden");
    instructionModal.classList.remove("hidden");
    instructionModal.classList.add("flex");

    // Cacher les conseils par d√©faut √† l'ouverture
    const tipsSection = document.getElementById("tipsSection");
    if (tipsSection) tipsSection.classList.add("hidden");

    // Ajouter les gestionnaires pour les suggestions de zone
    document.querySelectorAll(".zone-suggestion").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const zone = (e.currentTarget as HTMLElement).dataset.zone || "";
        instructionLocation.value = zone;
        instructionLocation.focus();
      });
    });
  });

  // Gestionnaire pour le bouton de conseils
  const toggleTipsBtn = document.getElementById("toggleTipsBtn");
  const tipsSection = document.getElementById("tipsSection");
  const closeTipsBtn = document.getElementById("closeTipsBtn");

  if (toggleTipsBtn && tipsSection) {
    toggleTipsBtn.addEventListener("click", () => {
      tipsSection.classList.toggle("hidden");
    });
  }

  if (closeTipsBtn && tipsSection) {
    closeTipsBtn.addEventListener("click", () => {
      tipsSection.classList.add("hidden");
    });
  }

  // √âcouter les √©v√©nements du mask editor
  window.addEventListener("maskEditorSave", ((event: CustomEvent<{ maskDataUrl: string }>) => {
    currentMaskDataUrl = event.detail.maskDataUrl;
    maskIndicator.classList.remove("hidden");
    maskIndicator.classList.add("flex");
  }) as EventListener);

  // Gestionnaire pour l'√©diteur de masque
  openMaskEditorBtn.addEventListener("click", () => {
    if (!selectedImage) {
      alert("Veuillez d'abord s√©lectionner une image");
      return;
    }

    // Cr√©er l'URL de l'image originale
    const imageUrl = URL.createObjectURL(selectedImage);

    // Obtenir la r√©f√©rence s√©lectionn√©e pour l'aper√ßu
    let referenceImageUrl: string | undefined;
    if (useLibrary) {
      const selectedRadio = document.querySelector(
        'input[name="selectedReference"]:checked'
      ) as HTMLInputElement;
      if (selectedRadio) {
        const refPath = selectedRadio.value;
        referenceImageUrl = getImageUrl(refPath);
      }
    } else if (newReferenceFile) {
      referenceImageUrl = URL.createObjectURL(newReferenceFile);
    }

    // √âmettre l'√©v√©nement pour ouvrir l'√©diteur de masque
    window.dispatchEvent(new CustomEvent("openMaskEditor", {
      detail: { imageUrl, referenceImage: referenceImageUrl }
    }));
  });

  useLibraryBtn.addEventListener("click", () => {
    useLibrary = true;
    useLibraryBtn.className =
      "flex-1 px-3 py-2 border-2 border-indigo-500 bg-indigo-50 text-indigo-700 rounded-lg text-sm font-medium";
    useNewBtn.className =
      "flex-1 px-3 py-2 border-2 border-slate-200 text-slate-600 rounded-lg text-sm font-medium hover:border-slate-300";
    librarySelection.classList.remove("hidden");
    newReferenceUpload.classList.add("hidden");
  });

  // Gestion des tabs de dossiers dans la modal
  const folderTabs = document.querySelectorAll(".folder-tab");
  const refItems = document.querySelectorAll(".ref-item");

  folderTabs.forEach((tab) => {
    tab.addEventListener("click", () => {
      const folderId = (tab as HTMLElement).dataset.folder;

      // Mise √† jour des styles des tabs
      folderTabs.forEach((t) => {
        if (t === tab) {
          t.className =
            "folder-tab px-3 py-1.5 text-xs rounded-full whitespace-nowrap bg-indigo-100 text-indigo-700 font-medium flex items-center gap-1";
        } else {
          t.className =
            "folder-tab px-3 py-1.5 text-xs rounded-full whitespace-nowrap bg-slate-100 text-slate-600 hover:bg-slate-200 flex items-center gap-1";
        }
      });

      // Filtrer les r√©f√©rences
      refItems.forEach((item) => {
        const itemFolder = (item as HTMLElement).dataset.folder;
        if (folderId === "all") {
          (item as HTMLElement).style.display = "";
        } else if (folderId === "none") {
          (item as HTMLElement).style.display =
            itemFolder === "none" ? "" : "none";
        } else {
          (item as HTMLElement).style.display =
            itemFolder === folderId ? "" : "none";
        }
      });
    });
  });

  useNewBtn.addEventListener("click", () => {
    useLibrary = false;
    useNewBtn.className =
      "flex-1 px-3 py-2 border-2 border-indigo-500 bg-indigo-50 text-indigo-700 rounded-lg text-sm font-medium";
    useLibraryBtn.className =
      "flex-1 px-3 py-2 border-2 border-slate-200 text-slate-600 rounded-lg text-sm font-medium hover:border-slate-300";
    librarySelection.classList.add("hidden");
    newReferenceUpload.classList.remove("hidden");
  });

  newRefDropZone.addEventListener("click", () => newReferenceInput.click());
  newReferenceInput.addEventListener("change", async (e) => {
    const file = (e.target as HTMLInputElement).files?.[0];
    if (file) {
      newReferenceFile = file;

      // Pour les formats Apple, convertir pour l'aper√ßu
      if (isAppleFormat(file)) {
        newRefPlaceholder.innerHTML =
          '<div class="text-2xl">üîÑ</div><p class="text-xs text-slate-500">Conversion...</p>';
        try {
          const formData = new FormData();
          formData.append("image", file);
          const response = await fetch("/api/convert-image", {
            method: "POST",
            body: formData,
          });
          if (!response.ok) throw new Error("√âchec");
          const blob = await response.blob();
          newRefPreviewImg.src = URL.createObjectURL(blob);
        } catch {
          newRefPreviewImg.src = "";
        }
      } else {
        newRefPreviewImg.src = URL.createObjectURL(file);
      }

      newRefPlaceholder.classList.add("hidden");
      newRefPreview.classList.remove("hidden");
    }
  });

  cancelInstructionBtn.addEventListener("click", () => {
    instructionModal.classList.add("hidden");
    instructionModal.classList.remove("flex");
  });

  confirmInstructionBtn.addEventListener("click", async () => {
    const location = instructionLocation.value.trim();
    if (!location) {
      alert("Veuillez entrer un emplacement");
      return;
    }

    if (useLibrary) {
      const selected = document.querySelector(
        'input[name="selectedReference"]:checked'
      ) as HTMLInputElement;
      if (!selected) {
        alert("Veuillez s√©lectionner une r√©f√©rence");
        return;
      }
      instructions.push({
        id: crypto.randomUUID(),
        location,
        referenceId: selected.value,
        referencePath: selected.dataset.path || "",
        referenceName: selected.dataset.name || undefined,
        maskDataUrl: currentMaskDataUrl || undefined,
      });
    } else {
      if (!newReferenceFile) {
        alert("Veuillez s√©lectionner une image");
        return;
      }
      instructions.push({
        id: crypto.randomUUID(),
        location,
        referencePath: URL.createObjectURL(newReferenceFile),
        referenceName: newReferenceName.value.trim() || undefined,
        isNew: true,
        newFile: newReferenceFile,
        maskDataUrl: currentMaskDataUrl || undefined,
      });
    }

    updateInstructionsList();
    instructionModal.classList.add("hidden");
    instructionModal.classList.remove("flex");
  });

  instructionModal.addEventListener("click", (e) => {
    if (e.target === instructionModal) {
      instructionModal.classList.add("hidden");
      instructionModal.classList.remove("flex");
    }
  });

  // √âtape 3 - G√©n√©ration
  let timerInterval: ReturnType<typeof setInterval> | null = null;
  let startTime = 0;

  function updateTimer() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const mins = Math.floor(elapsed / 60)
      .toString()
      .padStart(2, "0");
    const secs = (elapsed % 60).toString().padStart(2, "0");
    const timerEl = document.getElementById("logTimer");
    if (timerEl) timerEl.textContent = `${mins}:${secs}`;
  }

  function startTimer() {
    startTime = Date.now();
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(updateTimer, 1000);
    updateTimer();
  }

  function stopTimer() {
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
  }

  function updateGenerationStep(
    stepId: string,
    status: "pending" | "active" | "done" | "error"
  ) {
    const step = document.getElementById(stepId);
    if (!step) return;

    const iconContainer = step.querySelector(".step-icon") as HTMLElement;
    const iconSpan = iconContainer?.querySelector("span") as HTMLElement;
    const statusEl = step.querySelector(".step-status") as HTMLElement;

    step.classList.remove(
      "opacity-50",
      "border-green-300",
      "border-indigo-300",
      "border-red-300",
      "bg-green-50",
      "bg-indigo-50",
      "bg-red-50"
    );
    iconContainer?.classList.remove(
      "bg-green-100",
      "bg-indigo-100",
      "bg-red-100",
      "bg-slate-100"
    );

    switch (status) {
      case "pending":
        step.classList.add("opacity-50");
        iconContainer?.classList.add("bg-slate-100");
        if (iconSpan) iconSpan.textContent = "‚è≥";
        if (statusEl) statusEl.innerHTML = "";
        break;
      case "active":
        step.classList.add("bg-indigo-50", "border-indigo-300");
        iconContainer?.classList.add("bg-indigo-100");
        if (iconSpan)
          iconSpan.innerHTML = `<svg class="w-4 h-4 animate-spin text-indigo-600" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
        if (statusEl)
          statusEl.innerHTML = `<span class="text-xs text-indigo-600 font-medium">En cours...</span>`;
        break;
      case "done":
        step.classList.add("bg-green-50", "border-green-300");
        iconContainer?.classList.add("bg-green-100");
        if (iconSpan) iconSpan.textContent = "‚úì";
        if (statusEl)
          statusEl.innerHTML = `<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
        break;
      case "error":
        step.classList.add("bg-red-50", "border-red-300");
        iconContainer?.classList.add("bg-red-100");
        if (iconSpan) iconSpan.textContent = "‚úï";
        if (statusEl)
          statusEl.innerHTML = `<svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;
        break;
    }
  }

  function resetGenerationSteps() {
    ["step-upload", "step-analyze", "step-plan", "step-generate"].forEach(
      (id) => {
        updateGenerationStep(id, "pending");
      }
    );
    // Vider les logs et reset timer
    const logsContent = document.getElementById("logsContent");
    if (logsContent) logsContent.innerHTML = "";
    const timerEl = document.getElementById("logTimer");
    if (timerEl) timerEl.textContent = "00:00";
  }

  function createShareButtons(imageUrl: string) {
    // Met √† jour l'URL de l'image dans le composant ShareButtons
    const wrapper = document.getElementById("shareButtonsWrapper");
    if (!wrapper) return;

    const shareComponent = wrapper.querySelector(".share-container");
    if (shareComponent) {
      shareComponent.setAttribute("data-image-url", imageUrl);
    }
  }

  function addLog(icon: string, message: string, type?: string) {
    const logsContent = document.getElementById("logsContent");
    if (!logsContent) return;

    const timestamp = new Date().toLocaleTimeString("fr-FR", {
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
    });

    const logLine = document.createElement("div");
    logLine.className =
      "flex items-start gap-2 font-mono text-xs animate-fadeIn";

    let textColor = "text-slate-400";
    let bgColor = "";
    if (type === "success") {
      textColor = "text-emerald-400";
      bgColor = "bg-emerald-500/10 rounded px-1";
    }
    if (type === "error") {
      textColor = "text-red-400";
      bgColor = "bg-red-500/10 rounded px-1";
    }
    if (type === "header") {
      textColor = "text-cyan-400 font-semibold";
    }

    logLine.innerHTML = `
      <span class="text-slate-600 shrink-0">${timestamp}</span>
      <span class="shrink-0">${icon}</span>
      <span class="${textColor} ${bgColor} break-all">${message}</span>
    `;
    logsContent.appendChild(logLine);

    // Auto-scroll vers le bas
    logsContent.scrollTo({
      top: logsContent.scrollHeight,
      behavior: "smooth",
    });
  }

  toStep3Btn.addEventListener("click", async () => {
    goToStep(3);
    generatingState.classList.remove("hidden");
    resultState.classList.add("hidden");
    errorState.classList.add("hidden");
    resetGenerationSteps();
    startTimer();

    // Afficher l'avertissement mobile si on est sur mobile
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || window.innerWidth < 768;
    const mobileWarning = document.getElementById("mobileWarning");
    if (isMobile && mobileWarning) {
      mobileWarning.classList.remove("hidden");
    }

    // Emp√™cher la mise en veille sur mobile pendant la g√©n√©ration
    let wakeLock: WakeLockSentinel | null = null;
    try {
      if ('wakeLock' in navigator) {
        wakeLock = await (navigator as any).wakeLock.request('screen');
        console.log('[Mobile] Wake Lock activ√©');
      }
    } catch (e) {
      console.log('[Mobile] Wake Lock non disponible');
    }

    // Variables pour le polling de fallback (d√©clar√©es ici pour √™tre accessibles dans le catch)
    let currentGenerationId: string | null = null;

    // Fonction de polling pour r√©cup√©rer le r√©sultat si d√©connect√©
    const pollForResult = async (genId: string): Promise<void> => {
      addLog("üîÑ", "V√©rification du statut...");
      for (let i = 0; i < 60; i++) { // Max 5 minutes (60 * 5s)
        await new Promise(r => setTimeout(r, 5000));
        try {
          const statusRes = await fetch(`/api/generation-status?id=${genId}`);
          if (!statusRes.ok) continue;
          const status = await statusRes.json();
          
          if (status.status === 'completed' && status.generatedImage) {
            // Succ√®s!
            stopTimer();
            ["step-upload", "step-analyze", "step-plan", "step-generate"].forEach(id => updateGenerationStep(id, "done"));
            
            const cleanPath = (p: string) => p.startsWith("/") ? p.slice(1) : p;
            resultBeforeImg.src = `/api/images/${cleanPath(status.originalImage)}`;
            resultAfterImg.src = `/api/images/${cleanPath(status.generatedImage)}`;
            resultAfterImg.classList.remove("hidden");
            
            generatingState.classList.add("hidden");
            resultState.classList.remove("hidden");
            addLog("‚úÖ", "G√©n√©ration termin√©e!", "success");
            return;
          } else if (status.status === 'failed') {
            throw new Error("La g√©n√©ration a √©chou√©");
          }
          // processing - on continue √† attendre
          addLog("‚è≥", `En cours... (${i + 1})`);
        } catch (e) {
          // Erreur r√©seau, on r√©essaie
        }
      }
      throw new Error("D√©lai d'attente d√©pass√©");
    };

    try {
      const formData = new FormData();
      formData.append("image", selectedImage!);
      formData.append(
        "instructions",
        JSON.stringify(
          instructions.map((i) => ({
            location: i.location,
            referenceId: i.referenceId,
            referenceName: i.referenceName,
            isNew: i.isNew,
            hasMask: !!i.maskDataUrl,
          }))
        )
      );

      // Ajouter les nouvelles r√©f√©rences
      instructions.forEach((instr, idx) => {
        if (instr.isNew && instr.newFile) {
          formData.append(`newRef_${idx}`, instr.newFile);
        }
      });

      // Ajouter les masques
      for (let idx = 0; idx < instructions.length; idx++) {
        const instr = instructions[idx];
        if (instr.maskDataUrl) {
          // Convertir dataURL en Blob
          const response = await fetch(instr.maskDataUrl);
          const blob = await response.blob();
          formData.append(`mask_${idx}`, blob, `mask_${idx}.png`);
        }
      }

      // AbortController avec timeout de 10 minutes pour mobile
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 600000); // 10 minutes

      // Utiliser fetch avec streaming pour le SSE
      const response = await fetch("/api/generate-stream", {
        method: "POST",
        body: formData,
        signal: controller.signal,
        // Note: keepalive incompatible avec gros payloads, on l'enl√®ve
      });

      clearTimeout(timeoutId);

      if (!response.ok) {
        const errorText = await response.text().catch(() => "");
        throw new Error(errorText || "Erreur de connexion au serveur");
      }

      const reader = response.body?.getReader();
      const decoder = new TextDecoder();
      let buffer = "";
      let currentEvent = ""; // Garder l'√©v√©nement en cours entre les chunks

      if (!reader) {
        throw new Error("Le streaming n'est pas support√©");
      }

      // Fonction pour traiter les lignes du buffer
      const processLines = (lines: string[]) => {
        for (const line of lines) {
          console.log("[SSE] Line:", line);
          
          if (line.startsWith("event: ")) {
            currentEvent = line.substring(7).trim();
            console.log("[SSE] Event set to:", currentEvent);
          } else if (line.startsWith("data: ")) {
            try {
              const data = JSON.parse(line.substring(6));
              console.log("[SSE] Processing event:", currentEvent, "data:", data);

              // Capturer l'ID de g√©n√©ration pour le polling
              if (currentEvent === "generationId") {
                currentGenerationId = data.id;
                console.log("[SSE] Generation ID captured:", currentGenerationId);
              } else if (currentEvent === "log") {
                addLog(data.icon || "üìù", data.message, data.type);
              } else if (currentEvent === "step") {
                updateGenerationStep(`step-${data.step}`, data.status);
              } else if (currentEvent === "error") {
                if (data.noCredits) {
                  window.location.href = "/no-credits";
                  return;
                }
                throw new Error(data.message);
              } else if (currentEvent === "complete") {
                console.log("[SSE] COMPLETE event received!");
                try {
                  stopTimer();
                  console.log("[SSE] Timer stopped");
                  
                  // Marquer toutes les √©tapes comme termin√©es
                  [
                    "step-upload",
                    "step-analyze",
                    "step-plan",
                    "step-generate",
                  ].forEach((id) => updateGenerationStep(id, "done"));
                  console.log("[SSE] Steps updated");

                  // Nettoyer les chemins (enlever le / initial si pr√©sent)
                  const cleanPath = (path: string) =>
                    path.startsWith("/") ? path.slice(1) : path;

                  console.log("[SSE] Setting before image:", data.originalImage);
                  resultBeforeImg.src = `/api/images/${cleanPath(data.originalImage)}`;

                  let generatedImageUrl = "";
                  if (data.generatedImage) {
                    generatedImageUrl = `/api/images/${cleanPath(data.generatedImage)}`;
                    console.log("[SSE] Setting after image:", generatedImageUrl);
                    resultAfterImg.src = generatedImageUrl;
                    resultAfterImg.classList.remove("hidden");
                    resultDescription.classList.add("hidden");
                  } else if (data.description) {
                    resultDescription.innerHTML = `<p class="whitespace-pre-wrap">${data.description}</p>`;
                    resultDescription.classList.remove("hidden");
                    resultAfterImg.classList.add("hidden");
                  }

                  // Cr√©er les boutons de partage
                  console.log("[SSE] Creating share buttons");
                  createShareButtons(generatedImageUrl || resultBeforeImg.src);

                  // Afficher les masques combin√©s si disponibles
                  console.log("[SSE] Processing combined masks");
                  const combinedMasksSection = document.getElementById("combinedMasksSection") as HTMLDivElement;
                  const combinedMasksContainer = document.getElementById("combinedMasksContainer") as HTMLDivElement;
                  
                  if (data.combinedMaskPaths && data.combinedMaskPaths.length > 0 && combinedMasksContainer) {
                    combinedMasksContainer.innerHTML = "";
                    data.combinedMaskPaths.forEach((maskPath: string, index: number) => {
                      const maskUrl = `/api/images/${cleanPath(maskPath)}`;
                      const maskCard = document.createElement("div");
                      maskCard.className = "border border-slate-200 rounded-lg p-3 bg-slate-50";
                      maskCard.innerHTML = `
                        <p class="text-xs text-slate-500 mb-2">Masque combin√© ${index + 1}</p>
                        <img src="${maskUrl}" alt="Masque combin√© ${index + 1}" class="w-full rounded cursor-pointer hover:opacity-90 transition-opacity lightbox-trigger" />
                        <a href="${maskUrl}" download="masque-combine-${index + 1}.png" class="mt-2 inline-flex items-center gap-1 text-xs text-indigo-600 hover:text-indigo-800">
                          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                          </svg>
                          T√©l√©charger
                        </a>
                      `;
                      combinedMasksContainer.appendChild(maskCard);
                    });
                    if (combinedMasksSection) combinedMasksSection.classList.remove("hidden");
                  } else {
                    if (combinedMasksSection) combinedMasksSection.classList.add("hidden");
                  }

                  console.log("[SSE] Showing result state");
                  generatingState.classList.add("hidden");
                  resultState.classList.remove("hidden");
                  console.log("[SSE] COMPLETE processing finished!");
                } catch (completeError) {
                  console.error("[SSE] Error in complete handler:", completeError);
                }
              }
            } catch (e) {
              console.error("[SSE] Parse error:", e);
            }
          }
        }
      };

      // Lire le stream
      while (true) {
        const { done, value } = await reader.read();
        
        if (done) {
          console.log("[SSE] Stream done, buffer remaining:", buffer);
          // Traiter le reste du buffer quand le stream est termin√©
          if (buffer.trim()) {
            const finalLines = buffer.split("\n");
            console.log("[SSE] Processing final lines:", finalLines);
            processLines(finalLines);
          }
          console.log("[SSE] Stream processing complete");
          break;
        }

        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split("\n");
        buffer = lines.pop() || "";
        processLines(lines);
      }
    } catch (error: any) {
      console.error("Erreur SSE:", error);
      
      // Si on a un ID de g√©n√©ration, essayer le polling
      if (currentGenerationId) {
        addLog("üì°", "Connexion perdue, v√©rification du statut...");
        try {
          await pollForResult(currentGenerationId);
          return; // Succ√®s via polling
        } catch (pollError: any) {
          console.error("Polling √©chou√©:", pollError);
        }
      }
      
      stopTimer();
      
      // D√©terminer un message d'erreur plus clair
      let errorMsg = error.message || "Erreur inconnue";
      if (error.name === 'AbortError') {
        errorMsg = "La g√©n√©ration a pris trop de temps. Veuillez r√©essayer.";
      } else if (error.message === 'Failed to fetch' || error.message?.includes('network')) {
        errorMsg = "Connexion perdue. V√©rifiez votre connexion internet et r√©essayez.";
      }
      
      addLog("‚ùå", errorMsg, "error");
      // Marquer l'√©tape en cours comme erreur
      ["step-upload", "step-analyze", "step-plan", "step-generate"].forEach(
        (id) => {
          const step = document.getElementById(id);
          if (step && !step.classList.contains("bg-green-50")) {
            updateGenerationStep(id, "error");
          }
        }
      );
      generatingState.classList.add("hidden");
      errorState.classList.remove("hidden");
      errorMessage.textContent = errorMsg;
    } finally {
      // Lib√©rer le wake lock
      if (wakeLock) {
        try {
          await wakeLock.release();
          console.log('[Mobile] Wake Lock lib√©r√©');
        } catch (e) {}
      }
    }
  });

  newGenerationBtn.addEventListener("click", () => {
    selectedImage = null;
    instructions = [];
    uploadPlaceholder.classList.remove("hidden");
    imagePreview.classList.add("hidden");
    toStep2Btn.disabled = true;
    updateInstructionsList();
    goToStep(1);
  });

  retryBtn.addEventListener("click", () => {
    goToStep(2);
  });

  // Toggle masques combin√©s
  const toggleCombinedMasksBtn = document.getElementById("toggleCombinedMasksBtn");
  const combinedMasksContainer = document.getElementById("combinedMasksContainer");
  const combinedMasksChevron = document.getElementById("combinedMasksChevron");
  
  toggleCombinedMasksBtn?.addEventListener("click", () => {
    const isHidden = combinedMasksContainer?.classList.contains("hidden");
    if (isHidden) {
      combinedMasksContainer?.classList.remove("hidden");
      combinedMasksChevron?.classList.add("rotate-180");
    } else {
      combinedMasksContainer?.classList.add("hidden");
      combinedMasksChevron?.classList.remove("rotate-180");
    }
  });

  // ========== LIGHTBOX ==========
  const lightboxModal = document.getElementById(
    "lightboxModal"
  ) as HTMLDivElement;
  const lightboxImg = document.getElementById(
    "lightboxImg"
  ) as HTMLImageElement;
  const lightboxClose = document.getElementById(
    "lightboxClose"
  ) as HTMLButtonElement;

  function openLightbox(src: string) {
    lightboxImg.src = src;
    lightboxModal.classList.remove("hidden");
    lightboxModal.classList.add("flex");
    document.body.style.overflow = "hidden";
  }

  function closeLightbox() {
    lightboxModal.classList.add("hidden");
    lightboxModal.classList.remove("flex");
    document.body.style.overflow = "";
  }

  // Clic sur les images r√©sultat pour ouvrir la lightbox
  resultBeforeImg.addEventListener("click", () => {
    if (resultBeforeImg.src) {
      openLightbox(resultBeforeImg.src);
    }
  });

  resultAfterImg.addEventListener("click", () => {
    if (resultAfterImg.src) {
      openLightbox(resultAfterImg.src);
    }
  });

  // Fermer la lightbox
  lightboxClose.addEventListener("click", closeLightbox);
  lightboxModal.addEventListener("click", (e) => {
    if (e.target === lightboxModal) {
      closeLightbox();
    }
  });

  // Fermer avec Escape
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && !lightboxModal.classList.contains("hidden")) {
      closeLightbox();
    }
  });
</script>
