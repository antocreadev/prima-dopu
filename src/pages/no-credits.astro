---
import Layout from "../layouts/Layout.astro";
import { SignedIn, SignedOut } from "@clerk/astro/components";
import { getUserCredits, getCreditStats, type PlanType } from "../lib/db";
import { getUserPlan } from "../lib/plans";
import { getSubscription, getCreditsBalance } from "../lib/subscriptions";

const auth = Astro.locals.auth();
const userId = auth.userId;

if (!userId) {
  return Astro.redirect("/sign-in");
}

// D√©terminer le plan de l'utilisateur
const userPlanInfo = getUserPlan(userId);
const isAdmin = userPlanInfo.isAdmin === true;

// Les admins ne devraient jamais voir cette page
if (isAdmin) {
  return Astro.redirect("/generate");
}

const userPlan = userPlanInfo.planType;
const isPaid = userPlanInfo.isPaid;

// R√©cup√©rer les infos Stripe
const subscription = getSubscription(userId);
const bonusCredits = getCreditsBalance(userId);

// Passer les cr√©dits bonus aux stats
const stats = getCreditStats(userId, userPlan, false, bonusCredits);

// D√©terminer les suggestions selon le plan actuel
// Free ‚Üí Proposer abonnement
// Standard ‚Üí Proposer upgrade Pro OU acheter cr√©dits
// Pro ‚Üí Proposer acheter cr√©dits uniquement
---

<Layout title="Plus de cr√©dits - PrimaDopu">
  <SignedOut>
    <div class="text-center py-20">
      <p class="text-slate-600">
        Veuillez vous connecter pour acc√©der √† cette page.
      </p>
    </div>
  </SignedOut>
  <SignedIn>
    <div class="max-w-3xl mx-auto text-center">
      <!-- Ic√¥ne -->
      <div
        class="inline-flex items-center justify-center w-24 h-24 bg-orange-100 rounded-full mb-6"
      >
        <svg
          class="w-12 h-12 text-orange-600"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
          ></path>
        </svg>
      </div>

      <h1 class="text-3xl font-bold text-slate-900 mb-4">
        {userPlan === "free" ? (
          "Vos 3 g√©n√©rations gratuites sont √©puis√©es"
        ) : userPlan === "pro" ? (
          "Vous avez utilis√© vos 50 g√©n√©rations ce mois"
        ) : (
          "Vous avez utilis√© vos 25 g√©n√©rations ce mois"
        )}
      </h1>

      <p class="text-xl text-slate-600 mb-8">
        {userPlan === "free" ? (
          "Passez √† un abonnement pour continuer √† cr√©er des visuels avant/apr√®s."
        ) : userPlan === "pro" ? (
          "Achetez des cr√©dits suppl√©mentaires pour continuer sans attendre le mois prochain."
        ) : (
          "Passez au plan Pro pour plus de g√©n√©rations, ou achetez des cr√©dits suppl√©mentaires."
        )}
      </p>

      <!-- Stats actuelles -->
      <div class="bg-slate-50 rounded-xl p-6 mb-8">
        <div class="flex items-center justify-center gap-8 flex-wrap">
          <div>
            <div class="text-3xl font-bold text-slate-900">{stats.used}</div>
            <div class="text-sm text-slate-600">Utilis√©es</div>
          </div>
          <div class="w-px h-12 bg-slate-300 hidden sm:block"></div>
          <div>
            <div class="text-3xl font-bold text-slate-900">{stats.limit}</div>
            <div class="text-sm text-slate-600">Maximum mensuel</div>
          </div>
          {bonusCredits > 0 && (
            <div class="w-px h-12 bg-slate-300 hidden sm:block"></div>
            <div>
              <div class="text-3xl font-bold text-amber-600">{bonusCredits}</div>
              <div class="text-sm text-slate-600">Cr√©dits bonus</div>
            </div>
          )}
        </div>
      </div>

      <!-- ===== UTILISATEUR FREE ===== -->
      {userPlan === "free" && (
        <div class="mb-8">
          <h2 class="text-xl font-bold text-slate-900 mb-6">
            üöÄ Choisissez votre abonnement
          </h2>
          <div class="grid md:grid-cols-2 gap-6">
            <!-- Standard -->
            <div class="bg-white rounded-xl border-2 border-orange-500 p-6 shadow-lg shadow-orange-100">
              <div class="text-sm text-orange-600 font-semibold mb-2">
                Recommand√©
              </div>
              <h3 class="text-xl font-bold text-slate-900 mb-1">Standard</h3>
              <div class="text-3xl font-bold text-slate-900 mb-2">
                25<span class="text-lg text-slate-500"> g√©n√©rations/mois</span>
              </div>
              <p class="text-slate-600 text-sm mb-4">
                Parfait pour les cr√©ateurs r√©guliers
              </p>
              <a
                href="/pricing"
                class="block w-full py-3 px-4 bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600 transition-colors text-center"
              >
                Voir les tarifs ‚Üí
              </a>
            </div>

            <!-- Pro -->
            <div class="bg-white rounded-xl border border-slate-200 p-6">
              <div class="text-sm text-slate-500 font-semibold mb-2">
                Volume √©lev√©
              </div>
              <h3 class="text-xl font-bold text-slate-900 mb-1">Pro</h3>
              <div class="text-3xl font-bold text-slate-900 mb-2">
                50<span class="text-lg text-slate-500"> g√©n√©rations/mois</span>
              </div>
              <p class="text-slate-600 text-sm mb-4">
                Pour les professionnels exigeants
              </p>
              <a
                href="/pricing"
                class="block w-full py-3 px-4 border-2 border-slate-800 text-slate-800 rounded-lg font-semibold hover:bg-slate-800 hover:text-white transition-colors text-center"
              >
                Voir les tarifs ‚Üí
              </a>
            </div>
          </div>
        </div>
      )}

      <!-- ===== UTILISATEUR STANDARD ===== -->
      {userPlan === "standard" && (
        <div class="mb-8">
          <div class="grid md:grid-cols-2 gap-6">
            <!-- Option 1: Upgrade vers Pro -->
            <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-xl p-6 text-white">
              <div class="text-sm text-orange-400 font-semibold mb-2">
                ‚≠ê Recommand√©
              </div>
              <h3 class="text-xl font-bold mb-2">Passer au Pro</h3>
              <p class="text-slate-300 text-sm mb-3">
                Doublez vos g√©n√©rations mensuelles
              </p>
              <div class="text-3xl font-bold mb-4">
                50<span class="text-lg text-slate-400"> /mois</span>
              </div>
              <ul class="space-y-2 mb-4 text-sm text-slate-300">
                <li class="flex items-center gap-2">
                  <span class="text-green-400">‚úì</span> 50 g√©n√©rations/mois
                </li>
                <li class="flex items-center gap-2">
                  <span class="text-green-400">‚úì</span> Tarif pr√©f√©rentiel cr√©dits
                </li>
              </ul>
              <button
                id="upgrade-to-pro"
                class="w-full py-3 px-4 bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600 transition-colors"
              >
                Passer au Pro ‚Üí
              </button>
            </div>

            <!-- Option 2: Acheter des cr√©dits -->
            <div class="bg-white rounded-xl border-2 border-amber-400 p-6">
              <div class="text-sm text-amber-600 font-semibold mb-2">
                üíé Solution imm√©diate
              </div>
              <h3 class="text-xl font-bold text-slate-900 mb-2">
                Acheter des cr√©dits
              </h3>
              <p class="text-slate-600 text-sm mb-3">
                Cr√©dits suppl√©mentaires sans expiration
              </p>
              <div class="p-3 bg-amber-50 rounded-lg mb-4">
                <p class="text-amber-800 text-sm font-medium">
                  üí° En tant qu'abonn√©, vous b√©n√©ficiez d'un tarif pr√©f√©rentiel
                </p>
              </div>
              <a
                href="/pricing#credits"
                class="block w-full py-3 px-4 bg-amber-500 text-white rounded-lg font-semibold hover:bg-amber-600 transition-colors text-center"
              >
                Acheter des cr√©dits ‚Üí
              </a>
            </div>
          </div>
        </div>
      )}

      <!-- ===== UTILISATEUR PRO ===== -->
      {userPlan === "pro" && (
        <div class="mb-8">
          <div class="max-w-md mx-auto">
            <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border-2 border-amber-400 rounded-xl p-6">
              <div class="text-3xl mb-4">üíé</div>
              <h3 class="text-xl font-bold text-slate-900 mb-2">
                Acheter des cr√©dits suppl√©mentaires
              </h3>
              <p class="text-slate-600 mb-4">
                Continuez √† cr√©er sans attendre le mois prochain. Vos cr√©dits bonus n'expirent jamais !
              </p>
              <div class="p-3 bg-green-50 rounded-lg mb-4 border border-green-200">
                <p class="text-green-800 text-sm font-medium">
                  ‚úì En tant qu'abonn√© Pro, vous b√©n√©ficiez du meilleur tarif sur les cr√©dits
                </p>
              </div>
              <a
                href="/pricing"
                class="block w-full py-3 px-4 bg-amber-500 text-white rounded-lg font-semibold hover:bg-amber-600 transition-colors text-center"
              >
                Acheter des cr√©dits ‚Üí
              </a>
            </div>
          </div>
        </div>
      )}

      <!-- Info renouvellement -->
      {isPaid && subscription?.current_period_end && (
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-8">
          <p class="text-blue-800 text-sm">
            üìÖ Vos {userPlan === 'pro' ? '50' : '25'} g√©n√©rations mensuelles seront renouvel√©es le {' '}
            <strong>
              {new Date(subscription.current_period_end).toLocaleDateString('fr-FR', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
              })}
            </strong>
          </p>
        </div>
      )}

      <!-- Liens -->
      <div class="flex items-center justify-center gap-6 text-sm">
        <a href="/pricing" class="text-orange-600 hover:underline font-medium">
          Voir tous les tarifs ‚Üí
        </a>
        <a href="/history" class="text-slate-600 hover:text-slate-800">
          Mon historique
        </a>
        <a href="/profile" class="text-slate-600 hover:text-slate-800">
          Mon profil
        </a>
      </div>
    </div>
  </SignedIn>
</Layout>

<script>
  // Bouton upgrade vers Pro
  document.getElementById('upgrade-to-pro')?.addEventListener('click', async () => {
    // Rediriger vers le pricing avec le toggle sur yearly pour le meilleur tarif
    window.location.href = '/pricing';
  });
</script>
