---
import Layout from "../layouts/Layout.astro";
import { SignedIn, SignedOut } from "@clerk/astro/components";
import { getUserPlan } from "../lib/plans";
import { getSubscription, getCreditsBalance } from "../lib/subscriptions";

const auth = Astro.locals.auth();
const userId = auth.userId;

// R√©cup√©rer le plan actuel si connect√©
let currentPlan = {
  planType: "free" as string,
  isPaid: false,
  creditsBalance: 0,
  hasSubscription: false,
};

if (userId) {
  const userPlanInfo = getUserPlan(userId);
  const subscription = getSubscription(userId);
  const creditsBalance = getCreditsBalance(userId);

  currentPlan = {
    planType: subscription?.plan_type || userPlanInfo.planType,
    isPaid:
      userPlanInfo.isPaid ||
      (subscription?.status === "active" && subscription?.plan_type !== "free"),
    creditsBalance,
    hasSubscription: !!subscription?.stripe_subscription_id,
  };
}
---

<Layout
  title="Tarifs - PrimaDopu"
  description="D√©couvrez nos offres d'abonnement pour cr√©er des visuels avant/apr√®s professionnels avec l'IA."
  disableStickyHeader={true}
>
  <div class="max-w-6xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="text-center mb-12">
      <h1 class="text-4xl md:text-5xl font-bold text-slate-900 mb-4">
        Tarifs simples et transparents
      </h1>
      <p class="text-xl text-slate-600 max-w-2xl mx-auto">
        Choisissez la formule adapt√©e √† vos besoins. Sans engagement.
      </p>
    </div>

    <!-- Plan actuel (si connect√© et abonn√©) -->
    <SignedIn>
      {
        currentPlan.isPaid && (
          <div class="mb-8 p-4 bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl border border-orange-200 text-center">
            <p class="text-orange-800">
              Vous √™tes actuellement sur le plan{" "}
              <strong class="capitalize">
                {currentPlan.planType === "pro"
                  ? "Pro (50 projets/mois)"
                  : "Standard (25 projets/mois)"}
              </strong>
              {currentPlan.creditsBalance > 0 && (
                <span class="ml-2 bg-orange-500 text-white text-xs px-2 py-1 rounded-full">
                  +{currentPlan.creditsBalance} cr√©dit(s) bonus
                </span>
              )}
            </p>
          </div>
        )
      }
    </SignedIn>

    <!-- Toggle Mensuel / Annuel -->
    <div class="flex justify-center mb-12">
      <div class="bg-slate-100 p-1.5 rounded-full flex items-center gap-1">
        <button
          id="toggle-monthly"
          class="px-6 py-2.5 rounded-full text-sm font-semibold transition-all billing-toggle"
          data-billing="monthly"
        >
          Mensuel
        </button>
        <button
          id="toggle-yearly"
          class="px-6 py-2.5 rounded-full text-sm font-semibold transition-all billing-toggle active flex items-center gap-2"
          data-billing="yearly"
        >
          Annuel
          <span
            class="bg-green-500 text-white text-xs px-2 py-0.5 rounded-full font-bold"
            >-25%</span
          >
        </button>
      </div>
    </div>

    <!-- Indicateur de chargement -->
    <div id="loading-products" class="text-center py-12">
      <div
        class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500"
      >
      </div>
      <p class="mt-4 text-slate-600">Chargement des offres...</p>
    </div>

    <!-- Grille des abonnements -->
    <div id="subscriptions-container" class="hidden mb-16">
      <div
        id="subscriptions-grid"
        class="grid md:grid-cols-3 gap-6 max-w-5xl mx-auto"
      >
        <!-- Les cartes seront g√©n√©r√©es dynamiquement -->
      </div>
    </div>

    <!-- Section cr√©dits suppl√©mentaires -->
    <div id="credits-section" class="hidden mb-20">
      <div class="text-center mb-8">
        <h2 class="text-2xl font-bold text-slate-900 mb-2" id="credits-title">
          Besoin de plus de g√©n√©rations ?
        </h2>
        <p class="text-slate-600">
          Achetez des cr√©dits suppl√©mentaires valables sans limite de temps.
        </p>
      </div>

      <div id="credits-grid" class="flex justify-center">
        <!-- La carte cr√©dits sera g√©n√©r√©e dynamiquement -->
      </div>
    </div>

    <!-- Erreur -->
    <div id="error-container" class="hidden text-center py-12">
      <p class="text-red-600 mb-4">Erreur lors du chargement des offres.</p>
      <button
        onclick="loadProducts()"
        class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-medium"
      >
        R√©essayer
      </button>
    </div>

    <SignedIn>
      {
        currentPlan.isPaid && (
          <div class="mb-8 p-4 bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl border border-orange-200 text-center">
            <button
              id="manage-subscription-btn"
              class="mt-3 text-sm text-orange-600 hover:text-orange-800 underline font-medium"
            >
              G√©rer mon abonnement ‚Üí
            </button>
          </div>
        )
      }
    </SignedIn>

    <!-- FAQ -->
    <div class="bg-white rounded-2xl border border-slate-200 p-8">
      <h2 class="text-2xl font-bold text-slate-900 mb-6 text-center">
        Questions fr√©quentes
      </h2>
      <div class="grid md:grid-cols-2 gap-8">
        <div>
          <h3 class="font-semibold text-slate-900 mb-2">
            Qu'est-ce qu'une g√©n√©ration ?
          </h3>
          <p class="text-slate-600 text-sm">
            Une g√©n√©ration = une transformation avant/apr√®s. Chaque cr√©ation
            utilise un cr√©dit.
          </p>
        </div>
        <div>
          <h3 class="font-semibold text-slate-900 mb-2">
            Les cr√©dits sont-ils report√©s ?
          </h3>
          <p class="text-slate-600 text-sm">
            Les cr√©dits mensuels sont remis √† z√©ro chaque mois. Les cr√©dits
            achet√©s √† l'unit√© n'expirent jamais.
          </p>
        </div>
        <div>
          <h3 class="font-semibold text-slate-900 mb-2">
            Puis-je annuler √† tout moment ?
          </h3>
          <p class="text-slate-600 text-sm">
            Oui, sans engagement. L'abonnement reste actif jusqu'√† la fin de la
            p√©riode pay√©e.
          </p>
        </div>
        <div>
          <h3 class="font-semibold text-slate-900 mb-2">
            Quelle est la diff√©rence annuel/mensuel ?
          </h3>
          <p class="text-slate-600 text-sm">
            L'abonnement annuel offre 25% de r√©duction. Vous payez 9 mois pour
            12 mois d'acc√®s.
          </p>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  .billing-toggle {
    color: #475569;
    background-color: transparent;
  }
  .billing-toggle.active {
    background-color: white;
    color: #0f172a;
    box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  }

  .plan-card {
    border-radius: 1rem;
    padding: 1.5rem;
    border-width: 2px;
    transition: all 0.3s;
  }
  .plan-card.popular {
    border-color: #f97316;
    background: linear-gradient(to bottom, #fff7ed, white);
    box-shadow:
      0 25px 50px -12px rgb(0 0 0 / 0.25),
      0 0 0 0 #ffedd5;
    transform: scale(1.05);
    z-index: 10;
  }
  .plan-card:not(.popular) {
    border-color: #e2e8f0;
    background-color: white;
  }
  .plan-card:not(.popular):hover {
    border-color: #fdba74;
  }
</style>

<script define:vars={{ currentPlan }}>
  // Variables depuis le serveur
  const userPlan = currentPlan;

  // √âtat du billing - ANNUEL par d√©faut
  let billingPeriod = "yearly";

  // Donn√©es des produits
  let productsData = null;

  // Toggle billing period
  document.querySelectorAll(".billing-toggle").forEach((btn) => {
    btn.addEventListener("click", () => {
      document
        .querySelectorAll(".billing-toggle")
        .forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");
      billingPeriod = btn.dataset.billing;
      if (productsData) renderSubscriptions(productsData.subscriptions);
    });
  });

  async function loadProducts() {
    const loadingEl = document.getElementById("loading-products");
    const subsContainer = document.getElementById("subscriptions-container");
    const creditsSection = document.getElementById("credits-section");
    const errorContainer = document.getElementById("error-container");

    try {
      loadingEl?.classList.remove("hidden");
      subsContainer?.classList.add("hidden");
      creditsSection?.classList.add("hidden");
      errorContainer?.classList.add("hidden");

      const response = await fetch("/api/stripe/products");
      if (!response.ok) throw new Error("Erreur API");

      productsData = await response.json();

      // Afficher les abonnements
      if (productsData.subscriptions.length > 0) {
        renderSubscriptions(productsData.subscriptions);
        subsContainer?.classList.remove("hidden");
      }

      // Afficher les cr√©dits
      if (productsData.credits.length > 0) {
        renderCredits(productsData.credits);
        creditsSection?.classList.remove("hidden");
      }

      loadingEl?.classList.add("hidden");
    } catch (error) {
      console.error("Erreur chargement produits:", error);
      loadingEl?.classList.add("hidden");
      errorContainer?.classList.remove("hidden");
    }
  }

  function renderSubscriptions(products) {
    const grid = document.getElementById("subscriptions-grid");
    grid.innerHTML = "";

    // Trouver les produits
    const standardProduct = products.find(
      (p) => p.type === "subscription_25" || p.name.includes("25")
    );
    const proProduct = products.find(
      (p) => p.type === "subscription_50" || p.name.includes("50")
    );

    // Prix
    const standardMonthly = standardProduct?.prices.find(
      (p) => p.interval === "month"
    );
    const standardYearly = standardProduct?.prices.find(
      (p) => p.interval === "year"
    );
    const proMonthly = proProduct?.prices.find((p) => p.interval === "month");
    const proYearly = proProduct?.prices.find((p) => p.interval === "year");

    // Liste compl√®te des fonctionnalit√©s (vert = inclus, gris = non inclus)
    const features = [
      { label: "IA avanc√©e", free: true, standard: true, pro: true },
      {
        label: "R√©sultat en ~3 minutes",
        free: true,
        standard: true,
        pro: true,
      },
      {
        label: "Images haute r√©solution",
        free: true,
        standard: true,
        pro: true,
      },
      { label: "Historique illimit√©", free: true, standard: true, pro: true },
      {
        label: "Biblioth√®que de r√©f√©rences",
        free: true,
        standard: true,
        pro: true,
      },
      {
        label: "Cr√©dits -50% (tarif abonn√©)",
        free: false,
        standard: true,
        pro: true,
      },
      { label: "Support prioritaire", free: false, standard: true, pro: true },
      {
        label: "Support pour d√©veloppement personnalis√©",
        free: false,
        standard: false,
        pro: true,
      },
    ];

    const renderFeature = (label, included, highlight = false) => {
      if (included) {
        return `<li class="flex items-center gap-2.5 py-1.5">
          <svg class="w-5 h-5 text-green-500 shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
          </svg>
          <span class="${highlight ? "font-semibold text-slate-900" : "text-slate-600"}">${label}</span>
        </li>`;
      } else {
        return `<li class="flex items-center gap-2.5 py-1.5">
          <svg class="w-5 h-5 text-slate-300 shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
          </svg>
          <span class="text-slate-400">${label}</span>
        </li>`;
      }
    };

    const isFreeCurrentPlan = userPlan.planType === "free" && !userPlan.isPaid;
    const isStandardCurrentPlan = userPlan.planType === "standard";
    const isProCurrentPlan = userPlan.planType === "pro";

    // Carte GRATUIT
    const freeCard = document.createElement("div");
    freeCard.className =
      "bg-white border-2 border-slate-200 rounded-2xl p-6 flex flex-col h-full";
    freeCard.innerHTML = `
      <div class="mb-4">
        <h3 class="text-xl font-bold text-slate-900">Gratuit</h3>
        <p class="text-slate-500 text-sm mt-1">Pour d√©couvrir</p>
      </div>
      <div class="mb-6">
        <div class="flex items-baseline gap-1">
          <span class="text-4xl font-bold text-slate-900">0‚Ç¨</span>
        </div>
        <p class="text-slate-500 text-sm mt-1">Sans carte bancaire</p>
      </div>
      <div class="mb-4 pb-4 border-b border-slate-100">
        <p class="text-sm font-semibold text-slate-900">‚úì 3 g√©n√©rations au total</p>
      </div>
      <ul class="space-y-0.5 mb-6 flex-grow text-sm">
        ${features.map((f) => renderFeature(f.label, f.free)).join("")}
      </ul>
      ${
        isFreeCurrentPlan
          ? `
        <div class="py-3 px-4 bg-slate-100 text-slate-600 rounded-xl font-semibold text-center mt-auto">Plan actuel</div>
      `
          : `
        <a href="/sign-up" class="block py-3 px-4 bg-slate-100 text-slate-700 rounded-xl font-semibold text-center hover:bg-slate-200 transition-colors mt-auto">Commencer gratuitement</a>
      `
      }
    `;
    grid.appendChild(freeCard);

    // Carte STANDARD
    const standardCard = document.createElement("div");
    standardCard.className =
      "bg-white border-2 border-slate-200 rounded-2xl p-6 flex flex-col h-full";
    const standardPriceMonthly =
      billingPeriod === "yearly" && standardYearly
        ? Math.round(standardYearly.amount / 12 / 100)
        : (standardMonthly?.amount || 0) / 100;
    const standardPriceId =
      billingPeriod === "yearly" && standardYearly
        ? standardYearly.id
        : standardMonthly?.id;

    standardCard.innerHTML = `
      <div class="mb-4">
        <h3 class="text-xl font-bold text-slate-900">Standard</h3>
        <p class="text-slate-500 text-sm mt-1">Pour les cr√©ateurs r√©guliers</p>
      </div>
      <div class="mb-6">
        <div class="flex items-baseline gap-1">
          <span class="text-4xl font-bold text-slate-900">${standardPriceMonthly}‚Ç¨</span>
          <span class="text-slate-500">/mois</span>
        </div>
        ${
          billingPeriod === "yearly" && standardYearly
            ? `
          <p class="text-green-600 text-sm mt-1 font-medium">Factur√© ${standardYearly.amountFormatted}/an</p>
        `
            : `<p class="text-slate-500 text-sm mt-1">Facturation mensuelle</p>`
        }
      </div>
      <div class="mb-4 pb-4 border-b border-slate-100">
        <p class="text-sm font-semibold text-slate-900">‚úì 25 g√©n√©rations/mois</p>
      </div>
      <ul class="space-y-0.5 mb-6 flex-grow text-sm">
        ${features.map((f) => renderFeature(f.label, f.standard)).join("")}
      </ul>
      ${
        isStandardCurrentPlan
          ? `
        <div class="py-3 px-4 bg-orange-100 text-orange-700 rounded-xl font-semibold text-center mt-auto">‚úì Votre plan actuel</div>
      `
          : `
        <button onclick="checkout('${standardPriceId}')" class="w-full py-3 px-4 bg-slate-900 text-white rounded-xl font-semibold hover:bg-slate-800 transition-colors mt-auto">${userPlan.isPaid ? "Changer de plan" : "Commencer"}</button>
      `
      }
    `;
    grid.appendChild(standardCard);

    // Carte PRO (populaire)
    const proCard = document.createElement("div");
    proCard.className =
      "bg-slate-900 border-2 border-orange-500 rounded-2xl p-6 flex flex-col h-full relative";
    const proPriceMonthly =
      billingPeriod === "yearly" && proYearly
        ? Math.round(proYearly.amount / 12 / 100)
        : (proMonthly?.amount || 0) / 100;
    const proPriceId =
      billingPeriod === "yearly" && proYearly ? proYearly.id : proMonthly?.id;

    const renderProFeature = (label, included) => {
      if (included) {
        return `<li class="flex items-center gap-2.5 py-1.5">
          <svg class="w-5 h-5 text-green-400 shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
          </svg>
          <span class="text-slate-300">${label}</span>
        </li>`;
      } else {
        return `<li class="flex items-center gap-2.5 py-1.5">
          <svg class="w-5 h-5 text-slate-600 shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
          </svg>
          <span class="text-slate-500">${label}</span>
        </li>`;
      }
    };

    proCard.innerHTML = `
      <div class="absolute -top-3 left-1/2 -translate-x-1/2">
        <span class="bg-orange-500 text-white text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide">Le plus populaire</span>
      </div>
      <div class="mb-4 mt-2">
        <h3 class="text-xl font-bold text-white">Pro</h3>
        <p class="text-slate-400 text-sm mt-1">Pour les professionnels</p>
      </div>
      <div class="mb-6">
        <div class="flex items-baseline gap-1">
          <span class="text-4xl font-bold text-white">${proPriceMonthly}‚Ç¨</span>
          <span class="text-slate-400">/mois</span>
        </div>
        ${
          billingPeriod === "yearly" && proYearly
            ? `
          <p class="text-green-400 text-sm mt-1 font-medium">Factur√© ${proYearly.amountFormatted}/an</p>
        `
            : `<p class="text-slate-400 text-sm mt-1">Facturation mensuelle</p>`
        }
      </div>
      <div class="mb-4 pb-4 border-b border-slate-700">
        <p class="text-sm font-semibold text-white">‚úì 50 g√©n√©rations/mois</p>
      </div>
      <ul class="space-y-0.5 mb-6 flex-grow text-sm">
        ${features.map((f) => renderProFeature(f.label, f.pro)).join("")}
      </ul>
      ${
        isProCurrentPlan
          ? `
        <div class="py-3 px-4 bg-orange-500/20 text-orange-400 rounded-xl font-semibold text-center mt-auto">‚úì Votre plan actuel</div>
      `
          : `
        <button onclick="checkout('${proPriceId}')" class="w-full py-3 px-4 bg-orange-500 text-white rounded-xl font-semibold hover:bg-orange-600 transition-colors mt-auto">${userPlan.isPaid ? "Changer de plan" : "Commencer"}</button>
      `
      }
    `;
    grid.appendChild(proCard);
  }

  function renderCredits(products) {
    const grid = document.getElementById("credits-grid");
    grid.innerHTML = "";

    // Trouver les prix des cr√©dits
    const creditWithSub = products.find((p) => p.type === "credit_with_sub");
    const creditNoSub = products.find((p) => p.type === "credit_no_sub");

    // S√©lectionner le bon produit selon le statut abonn√©
    const product = userPlan.isPaid ? creditWithSub : creditNoSub;
    const price = product?.prices[0];

    if (!price) return;

    // Calculer la r√©duction pour le message marketing
    const priceWithSub = creditWithSub?.prices[0]?.amount || 0;
    const priceNoSub = creditNoSub?.prices[0]?.amount || 0;
    const discountPercent =
      priceNoSub > 0 ? Math.round((1 - priceWithSub / priceNoSub) * 100) : 50;

    const card = document.createElement("div");
    card.className =
      "rounded-2xl p-6 border-2 border-slate-200 bg-white hover:border-orange-300 transition-all max-w-md";

    card.innerHTML = `
      <div class="text-center mb-6">
        <div class="inline-flex items-center justify-center w-12 h-12 bg-gradient-to-br from-orange-400 to-orange-600 rounded-xl mb-3">
          <span class="text-2xl">üíé</span>
        </div>
        <h3 class="text-xl font-bold text-slate-900">Cr√©dits suppl√©mentaires</h3>
        <p class="text-slate-500 text-sm mt-1">N'expirent jamais</p>
      </div>

      <div class="text-center mb-6">
        <div class="flex items-baseline justify-center gap-1">
          <span class="text-4xl font-bold text-slate-900">${price.amountFormatted}</span>
          <span class="text-slate-500">/cr√©dit</span>
        </div>
        ${
          userPlan.isPaid
            ? `
          <div class="mt-2 inline-flex items-center gap-1.5 text-green-600 text-sm font-medium bg-green-50 px-3 py-1 rounded-full">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            Vous √©conomisez ${discountPercent}% (tarif abonn√©)
          </div>
        `
            : `
          <div class="mt-3 p-3 bg-orange-50 border border-orange-200 rounded-xl">
            <p class="text-sm text-orange-800">
              <span class="font-semibold">üí° Astuce :</span> Les abonn√©s paient seulement <strong>${creditWithSub?.prices[0]?.amountFormatted || "0,50‚Ç¨"}</strong>/cr√©dit 
              <span class="text-orange-600 font-semibold">(‚àí${discountPercent}%)</span>
            </p>
    
          </div>
        `
        }
      </div>
      
      <div class="flex items-center justify-center gap-3 mb-4 p-3 bg-slate-50 rounded-xl">
        <button 
          class="qty-btn w-10 h-10 flex items-center justify-center bg-white border border-slate-300 rounded-lg hover:bg-slate-100 text-lg font-bold transition-colors"
          data-action="decrease"
        >‚àí</button>
        <input 
          type="number" 
          min="1" 
          value="5" 
          class="credit-quantity w-20 px-2 py-2 border border-slate-300 rounded-lg text-center font-semibold text-lg"
          data-price-id="${price.id}"
          data-unit-price="${price.amount}"
        />
        <button 
          class="qty-btn w-10 h-10 flex items-center justify-center bg-white border border-slate-300 rounded-lg hover:bg-slate-100 text-lg font-bold transition-colors"
          data-action="increase"
        >+</button>
      </div>

      <div class="text-center mb-4">
        <span class="text-lg text-slate-600">Total : <strong class="credit-total text-slate-900 text-xl">${((price.amount * 5) / 100).toFixed(2)}‚Ç¨</strong></span>
      </div>
      
      <button 
        onclick="checkoutCredits('${price.id}', this)"
        class="w-full py-3.5 px-4 bg-slate-900 text-white rounded-xl font-semibold hover:bg-slate-800 transition-colors"
      >
        Acheter des cr√©dits
      </button>
      
      <p class="text-xs text-slate-400 text-center mt-4">
        Les cr√©dits s'ajoutent √† votre quota mensuel et ne sont jamais perdus.
      </p>
    `;

    // Gestion quantit√©
    const input = card.querySelector(".credit-quantity");
    const totalEl = card.querySelector(".credit-total");
    const qtyBtns = card.querySelectorAll(".qty-btn");

    const updateTotal = () => {
      let qty = parseInt(input.value) || 1;
      // Forcer la quantit√© minimum √† 1
      if (qty < 1) qty = 1;
      input.value = qty.toString();
      const total = (price.amount * qty) / 100;
      totalEl.textContent = `${total.toFixed(2)}‚Ç¨`;
    };

    input?.addEventListener("input", updateTotal);
    input?.addEventListener("blur", updateTotal); // Valider aussi quand on quitte le champ

    qtyBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        const action = btn.dataset.action;
        let qty = parseInt(input.value) || 1;
        if (action === "increase") qty++;
        if (action === "decrease" && qty > 1) qty--;
        input.value = qty.toString();
        updateTotal();
      });
    });

    grid.appendChild(card);
  }

  async function checkout(priceId) {
    try {
      const response = await fetch("/api/stripe/create-checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ priceId }),
      });

      const data = await response.json();

      if (data.url) {
        window.location.href = data.url;
      } else if (data.error === "Non authentifi√©") {
        window.location.href = "/sign-in?redirect=/pricing";
      } else {
        alert(data.error || "Erreur lors de la cr√©ation du paiement");
      }
    } catch (error) {
      console.error("Erreur checkout:", error);
      alert("Erreur lors de la cr√©ation du paiement");
    }
  }

  async function checkoutCredits(priceId, button) {
    const card = button.closest(".rounded-2xl");
    const input = card?.querySelector(".credit-quantity");
    let quantity = parseInt(input?.value) || 1;

    // Valider la quantit√© (minimum 1)
    if (quantity < 1) quantity = 1;

    try {
      const response = await fetch("/api/stripe/create-checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ priceId, quantity }),
      });

      const data = await response.json();

      if (data.url) {
        window.location.href = data.url;
      } else if (data.error === "Non authentifi√©") {
        window.location.href = "/sign-in?redirect=/pricing";
      } else {
        alert(data.error || "Erreur lors de la cr√©ation du paiement");
      }
    } catch (error) {
      console.error("Erreur checkout:", error);
      alert("Erreur lors de la cr√©ation du paiement");
    }
  }

  // Gestion du bouton "G√©rer mon abonnement"
  document
    .getElementById("manage-subscription-btn")
    ?.addEventListener("click", async () => {
      try {
        const response = await fetch("/api/stripe/create-portal", {
          method: "POST",
        });
        const data = await response.json();
        if (data.url) {
          window.location.href = data.url;
        }
      } catch (error) {
        console.error("Erreur portail:", error);
      }
    });

  // Exposer les fonctions au scope global
  window.checkout = checkout;
  window.checkoutCredits = checkoutCredits;
  window.loadProducts = loadProducts;

  // Charger les produits au d√©marrage
  document.addEventListener("DOMContentLoaded", loadProducts);
</script>
